{
  "progName": "LokiJS Demo",
  "htmlText": "<h3>Loki DB Demo using JQGrid</h3>\n<p>This demo is a test of Loki.js (an in-memory JSON object database), using it with jqGrid.  It allows adding, editing, deleting, filtering \n    and lets you load/save any of the three methods available (File API, Local Storage, Trident DB).\n    The demo database supports three collections (similar to a table) : vehicle class, manufacturer, and autos.  Autos depends on vehicle class and \n    manufacturer.  Currently the user interface only supports manipulating data in the autos class.  Data for all classes is \n    automatically initialized to a default sample set.</p> \n\n<button style=\"height:40px\" onclick=\"LoadAutoDB()\"><i class=\"fa fa-arrow-up\"></i> Load</button>\n<button style=\"height:40px\" onclick=\"SaveAutoDB()\"><i class=\"fa fa-download\"></i> Save</button>\n<div id=\"divLS\" style=\"display: none\">\n    <button style=\"height:40px\" onclick=\"LoadLocal()\"><i class=\"fa fa-arrow-circle-o-up\"></i> Load localStorage</button>\n    <button style=\"height:40px\" onclick=\"SaveLocal()\"><i class=\"fa fa-arrow-circle-o-down\"></i> Save localStorage</button>\n</div>\n<div id=\"divTDB\" style=\"display: none\">\n    <button style=\"height:40px\" onclick=\"LoadTridentDB()\"><i class=\"fa fa-arrow-circle-o-up\"></i> Load indexedDB</button>\n    <button style=\"height:40px\" onclick=\"SaveTridentDB()\"><i class=\"fa fa-arrow-circle-o-down\"></i> Save indexedDB</button>\n</div>\n<br/><br/>\n<table id=\"autogrid\"></table>\n<div id=\"autopager\"></div>\n\n<div id=\"dialog-confirm\" title=\"Confirm Delete\" style=\"display:none\">\n    <p>&nbsp;<i class=\"fa fa-trash-o fa-2x\"></i>&nbsp; Are you sure you want to delete this auto?</p>\n</div>\n\n",
  "scriptText": "// This is a demo of using the third party javascript library Loki\n// It helps create a cleaner, more defined database abstraction to a bunch of json object arrays \n\nif (localStorage) $(\"#divLS\").css(\"display\", \"inline\");\nif (sandbox.db) $(\"#divTDB\").css(\"display\", \"inline\");\n\nvar sandboxVars = {\n    // Keep a global instance to a Loki database object\n    db: new loki('Autos'),\n\n    manufacturers: null,\n    vclass: null, \n    autos: null,\n    lastsel: null\n};\n\nsandbox.events.clean = function() {\n    delete sandboxVars.db;\n    delete sandboxVars.manufacturers;\n    delete sandboxVars.autos;\n    delete sandboxVars.vclass;\n    delete sandboxVars.lastsel;\n};\n\n// keep track of last selected gridrow for graphical update purposes\n\ninitializeDB();\n\n// initialize the database with a set of autos, to do so we need to first set up \n// some manufacturers and models so our autos can reference their id's\nfunction initializeDB() {\n\n    // Collections would be like tables\n    sandboxVars.manufacturers = sandboxVars.db.addCollection('manufacturers', 'Manufacturer');\n    sandboxVars.vclass = sandboxVars.db.addCollection('vclass', 'VehicleClass');\n    sandboxVars.autos = sandboxVars.db.addCollection('autos', 'Autos');\n\n    // Now add some documents (loki term for records)\n    // In adding the records we are defining the structure\n    var ford = sandboxVars.manufacturers.insert({ name:'Ford', country:'US' });\n    var toyo = sandboxVars.manufacturers.insert({ name:'Toyota', country:'Japan' });\n    var vw = sandboxVars.manufacturers.insert({ name:'Volkswagen', country:'Germany' });\n\n    var classSedan = sandboxVars.vclass.insert({ name:'Sedan' });\n    var classSports = sandboxVars.vclass.insert({ name:'Sports' });\n    var classHybrid = sandboxVars.vclass.insert({ name:'Hybrid' });\n    var classCompact = sandboxVars.vclass.insert({ name:'Compact' });\n\n    sandboxVars.autos.insert({ name:'Focus', doors : 4, vclass: classCompact.$loki, manufacturer: ford.$loki });\n    sandboxVars.autos.insert({ name:'Fusion', doors: 4, vclass: classHybrid.$loki, manufacturer: ford.$loki });\n    sandboxVars.autos.insert({ name:'Mustang', doors: 2, vclass: classSports.$loki, manufacturer: ford.$loki });\n    sandboxVars.autos.insert({ name:'Camry', doors: 4, vclass: classSedan.$loki, manufacturer: toyo.$loki });\n    sandboxVars.autos.insert({ name:'Prius', doors: 4, vclass: classHybrid.$loki, manufacturer: toyo.$loki });\n    sandboxVars.autos.insert({ name:'Avalon', doors: 4, vclass: classSedan.$loki, manufacturer: toyo.$loki });\n    sandboxVars.autos.insert({ name:'Jetta', doors: 4, vclass: classSedan.$loki, manufacturer: vw.$loki });\n    sandboxVars.autos.insert({ name:'Passat', doors: 4, vclass: classSedan.$loki, manufacturer: vw.$loki });\n    sandboxVars.autos.insert({ name:'Beetle', doors: 2, vclass: classCompact.$loki, manufacturer: vw.$loki });\n\n    LoadAutosGrid();\n}\n\nfunction RefreshGrid() {\n    // this is how to refresh grid when using jsonstring local data\n    $(\"#autogrid\").setGridParam({\n        datastr: sandboxVars.autos.data,\n        datatype: \"jsonstring\" // !!! reset datatype\n    }).trigger(\"reloadGrid\");\n\n    // clear lastsel\n    sandboxVars.lastsel = null;\n}\n\nfunction LoadAutosGrid()\n{   \n    // if auto grid has already been initialized, then do a refresh with new data instead\n    if ($(\"#autogrid\")[0].grid) {\n        RefreshGrid();\n        return;\n    }\n\n    $(\"#autogrid\").jqGrid({\n        colModel: [\n            { name: 'Actions', index: 'ID', width: 170, align: 'left', formatter: lnkFormatter },\n            { name: 'name', index: 'name', width: \"110\", editable:true },\n            { name: 'doors', index: 'doors', width: \"100\", editable:true },\n            { name: 'vclass', index: 'vclass', width: 180, align: 'left', stype: 'select', editable: true, edittype: 'select', formatter: 'select',\n             editoptions: { value: CollectionToLookup(sandboxVars.vclass) }\n            },\n            { name: 'manufacturer', index: 'manufacturer', width: 180, align: 'left', stype: 'select', editable: true, edittype: 'select', formatter: 'select',\n             editoptions: { value: CollectionToLookup(sandboxVars.manufacturers) }\n            }\n        ],\n        pager: '#autopager',\n        datatype: \"jsonstring\",\n        datastr: sandboxVars.autos.data,\n        jsonReader: { repeatitems: false },\n        viewrecords: true,\n        caption: \"Autos\",\n        height: \"auto\",\n        onSelectRow: function (id) {\n            if (id != \"new_id\") {\n                var selAuto = sandboxVars.autos.get(parseInt(id));\n                var selManu = sandboxVars.manufacturers.get(parseInt(selAuto.manufacturer));\n\n                alertify.log('Country of origin : ' + selManu.country);\n            }\n        },\n        ignoreCase: true\n    });\n\n    //$(\"#autogrid\").jqGrid('navGrid', '#autogrid',\n    //    { add: false, edit: false, del: false }, {}, {}, {},\n    //    { multipleSearch: true, multipleGroup: true });\n\n    $(\"#autogrid\")\n        .navGrid(\"#autopager\", { edit: false, add: false, del: false, search: false })\n        .navButtonAdd(\"#autopager\", { caption: \"Add Auto\", buttonicon: \"ui-icon-plus\", onClickButton: function () { AddAuto(); }, position: \"last\" });\n\n    $(\"#autogrid\").jqGrid('filterToolbar', { defaultSearch: 'cn', stringResult: true });\n}\n\nfunction lnkFormatter(cellvalue, options, rowObject) {\n    return \"<div><div><a href='javascript:void(0)' title='Edit' onclick='EditAuto(\" + options.rowId + \"); return;'>Edit</a> | \" +\n        \"<a href='javascript:void(0)' title='Delete' onclick='DeleteAuto(\" + options.rowId + \"); return false;'>Delete</a></div>\" +\n        \"<div style='display:none'><a href='javascript:void(0)' title='Update' onclick='UpdateAuto(\\\"\" + options.rowId + \"\\\"); return false;'>Update</a> | \" +\n        \"<a href='javascript:void(0)' title='Cancel' onclick='CancelEdit(\\\"\" + options.rowId + \"\\\"); return false;'>Cancel</a></div></div>\";\n}\n\n// convert our lookup collections (vclass and manufacturer) to simple json of name/value pairs\n// jqgrid needs something like \nfunction CollectionToLookup(obj)\n{\n    var lookupString = \":\";\n    for (i=0;i<obj.data.length;i++) {\n        lookupString += \";\" + obj.data[i].$loki + \":\" + obj.data[i].name;\n    }\n\n    return lookupString;\n}\n\nfunction AddAuto()\n{\n    var s;\n\n    var dataRow = { name: '' };\n    $('#autogrid').addRowData('new_id', dataRow, \"first\");\n    $('#autogrid').editRow('new_id', true);\n\n    $('#new_id').find('div')[1].style.display = 'none';\n    $('#new_id').find('div')[2].style.display = 'block';\n\n    sandboxVars.lastsel = \"new_id\";\n}\n\nfunction EditAuto(id) {\n    // undo any previous rowedit\n    if (id && id != sandboxVars.lastsel) {\n        if (typeof (sandboxVars.lastsel) != \"undefined\" && sandboxVars.lastsel != null) {\n            var s = $(\"#autogrid\").jqGrid('restoreRow', sandboxVars.lastsel);\n            $('#' + sandboxVars.lastsel).find('div')[1].style.display = 'block';\n            $('#' + sandboxVars.lastsel).find('div')[2].style.display = 'none';\n        }\n        sandboxVars.lastsel = id;\n    }\n\n    // update action column to show update/cancel actions and hide edit/delete actions\n    $('#' + id).find('div')[1].style.display = 'none';\n    $('#' + id).find('div')[2].style.display = 'block';\n\n    // put row into edit mode\n    var gr = jQuery(\"#autogrid\").jqGrid('getGridParam', 'selrow');\n    jQuery(\"#autogrid\").editRow(id, true);\n}\n\nfunction CancelEdit(id) {\n    if (typeof (sandboxVars.lastsel) != \"undefined\") {\n\n        if (sandboxVars.lastsel == 'new_id') {\n            $(\"#new_id\").remove();\n            sandboxVars.lastsel = null;\n        }\n        else {\n            var s = $(\"#autogrid\").jqGrid('restoreRow', sandboxVars.lastsel);\n            $('#' + sandboxVars.lastsel).find('div')[1].style.display = 'block';\n            $('#' + sandboxVars.lastsel).find('div')[2].style.display = 'none';\n        }\n    }\n}\n\nfunction UpdateAuto(id) {\n\n    var autoName = $('#' + id).find('input')[0].value;\n    var numDoors = $('#' + id).find('input')[1].value;\n    var vclassId = $('#' + id).find('select').find(\":selected\")[0].value;\n    var manufacturerId = $('#' + id).find('select').find(\":selected\")[1].value;\n\n    var sErrors = \"\";\n\n    // require name, vclass, and manufacturer\n    if (autoName === \"\") { sErrors += \"Name is required.<br/>\"; }\n    if (vclassId === \"\") { sErrors += \"Vehicle Class is required.<br/>\"; }\n    if (manufacturerId === \"\") { sErrors += \"Manufacturer is required.<br/>\"; }\n\n    if (sErrors !== \"\") {\n        alertify.error(sErrors);\n        return;\n    }\n\n    if (id == 'new_id') {\n        sandboxVars.autos.insert({ name:autoName, doors : numDoors, vclass: vclassId, manufacturer: manufacturerId });\n\n        RefreshGrid();\n    }\n    else {\n        // toggle actions back to edit/delete\n        $('#' + sandboxVars.lastsel).find('div')[1].style.display = 'block';\n        $('#' + sandboxVars.lastsel).find('div')[2].style.display = 'none';\n\n        // Lookup and modify existing auto document\n        var currAuto = sandboxVars.autos.get(parseInt(id));\n        currAuto.name = autoName;\n        currAuto.doors = numDoors;\n        currAuto.manufacturer = manufacturerId;\n\n        RefreshGrid();\n    }\n}\n\nfunction DeleteAuto(id) {\n    $(\"#dialog-confirm\").dialog({\n        resizable: false,\n        height: 200,\n        width: 400,\n        modal: true,\n        buttons: {\n            \"Delete\": function () {\n                sandboxVars.autos.remove(sandboxVars.autos.get(id));\n                RefreshGrid();\n                $(this).dialog(\"close\");\n            },\n            Cancel: function () {\n                $(this).dialog(\"close\");\n            }\n        }\n    });\n}\n\nsandbox.files.userfileLoaded = function(filestring) {\n\n    // dont just JSON.parse this, hand off to Loki to reconstruct object and collections\n    // otherwise we would lose all the prototype methods and just have raw data not a real loki db\n    sandboxVars.db.loadJSON(filestring);\n\n    // we rehydrated loki db object and collections but old collection references still\n    // point to old db object. \n    sandboxVars.manufacturers = sandboxVars.db.getCollection(\"manufacturers\");\n    sandboxVars.vclass = sandboxVars.db.getCollection(\"vclass\");\n    sandboxVars.autos = sandboxVars.db.getCollection(\"autos\");\n\n    RefreshGrid();\n};\n\nfunction LoadAutoDB()\n{\n    sandbox.files.userfileShow();\n}\n\nfunction SaveAutoDB()\n{\n    var saveString = JSON.stringify(sandboxVars.db);\n    sandbox.files.saveTextFile(\"autos.db\", saveString);\n}\n\n//\n// DATABASE SERIALIZATION TO TRIDENT SANDBOX DB (uses IndexedDB)\n//\n\nfunction LoadTridentDB()\n{\n    if (sandbox.db) {\n\n        sandbox.db.getAppKey('LokiDemoApp', 'LokiDemo', function(e) {\n            var res = e.target.result;\n\n            if (!res) return;\n\n            sandboxVars.db.loadJSON(res.val);\n\n            // we rehydrated loki db object and collections but old collection references still\n            // point to old db object. \n            sandboxVars.manufacturers = sandboxVars.db.getCollection(\"manufacturers\");\n            sandboxVars.vclass = sandboxVars.db.getCollection(\"vclass\");\n            sandboxVars.autos = sandboxVars.db.getCollection(\"autos\");\n\n            RefreshGrid();\n\n        });\n\n    }\n    else {\n        alertify.log(\"Trident Database is not available.\");\n    }\n}\n\nfunction SaveTridentDB()\n{\n    if(sandbox.db) {\n        sandbox.db.setAppKey('LokiDemoApp', 'LokiDemo', JSON.stringify(sandboxVars.db));\n\n        alertify.log('Loki Demo database saved to Trident Database');\n    }\n    else {\n        alertify.log(\"Trident Database is not available.\");\n    }\n}\n\n//\n// DATABASE SERIALIZATION TO Local Storage\n//\n\nfunction LoadLocal()\n{\n    if (localStorage) {\n        if (localStorage.getItem(\"Loki Demo\") === null) {\n            alertify.error('Loki Demo database not in local storage');\n            return;\n        }\n\n        sandboxVars.db.loadJSON(localStorage.getItem(\"Loki Demo\"));\n\n        // we rehydrated loki db object and collections but old collection references still\n        // point to old db object. \n        sandboxVars.manufacturers = sandboxVars.db.getCollection(\"manufacturers\");\n        sandboxVars.vclass = sandboxVars.db.getCollection(\"vclass\");\n        sandboxVars.autos = sandboxVars.db.getCollection(\"autos\");\n\n        RefreshGrid();\n    }\n    else {\n        alertify.log(\"Local Storage is not available.\");\n    }\n}\n\nfunction SaveLocal()\n{\n    if(localStorage) {\n        localStorage.setItem(\"Loki Demo\", JSON.stringify(sandboxVars.db));\n        alertify.log('Loki Demo database saved to local storage');\n    }\n    else {\n        alertify.log(\"Local Storage is not available.\");\n    }\n}\n"
}