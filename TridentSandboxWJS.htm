<!DOCTYPE html>
<!--html -->
<html manifest="appcache.mf"> 
<head>
<title>Trident Sandbox</title>
<meta charset="utf-8">
<meta name="description" content="Trident Sandbox is an in-browser HTML/Javascript Scripting IDE that runs offline using the HTML 5 Application Cache." />

<!-- Leaving this uncommented while running local fs in metro ie seemed to have issues 
<meta name="application-name" content="Trident Sandbox"/>
<meta name="msapplication-TileColor" content="#1F7DD0"/>
<meta name="msapplication-square70x70logo" content="images_ide/live_tile/Poseidon-Small70.png"/>
<meta name="msapplication-square150x150logo" content="images_ide/live_tile/Poseidon-Normal150.png"/>
<meta name="msapplication-wide310x150logo" content="images_ide/live_tile/Poseidon-Wide310.png"/>
<meta name="msapplication-square310x310logo" content="images_ide/live_tile/Poseidon-Square310.jpg"/>
-->

<!--	TRIDENT SANDBOX : A 'jsfiddle-like' sandbox for Internet Explorer 10/11
		GitHub development at : https://github.com/obeliskos/TridentSandbox
		
		This is the WinJS version of Trident Sandbox.  WinJS is an open source Microsoft web 
		framework for creating tablet/touch web applications that behave similar to apps.
		
		Although all versions have access to the WinJS javascript file, this version also includes 
		their stylesheet which may affect your styles but help when styling their controls.
		
		This original intent of this is for use on Windows RT tablets, but it can be used on any
		computer running Internet Explorer 10/11 and possibly other browsers.
		
		It makes use of the FILE API which still seems to be somewhat browser specific, so to work 
		on other browsers you might need to change the I/O interface functions to work.  
		
		Html Files :
		TridentSandbox.htm : this is the main page which supports AppCache autoupdate
		SilentSandbox.htm : Same as the main TridentSandbox.htm page except it doesn't check for updates
		SandboxLoader.htm : For hosted/appcached, this works with Trident Save Slots as a Standalone Launcher of programs
-->

<!-- 
SCRIPT and STYLESHEET includes section
If you want to integrate other third party (or your own) javascript libraries to be
available for use by the sandbox app, add them here.  
-->

<script src="libraries/jquery/jquery-2.1.0.js"></script>
<script src="libraries/jquery-ui/jquery-ui-1.10.3.redmond/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.min.js"></script>
<link rel="stylesheet" type="text/css" href="libraries/jquery-ui/jquery-ui-1.10.3.redmond/jquery-ui-1.10.3.custom/css/redmond/jquery-ui-1.10.3.custom.css" />
<link rel="stylesheet" type="text/css" href="css/sandbox.css" />
<script src="libraries/winjs/js/WinJS.min.js"></script>
<script src="libraries/winjs/js/en-US/ui.strings.js"></script>
<link rel="stylesheet" type="text/css" href="libraries/winjs/css/ui-dark.css"/>
<script src="scripts/tridentlist.js"></script>
<script src="scripts/tridentdb.js"></script>
<script src="scripts/workerpool.js"></script>
<script src="libraries/alertify.js-0.3.11/lib/alertify.js"></script>
<script src="libraries/cryptojs/components/core.js"></script>
<script src="libraries/cryptojs/components/lib-typedarrays.js"></script>
<script src="libraries/cryptojs/components/enc-base64-min.js"></script>
<script src="libraries/cryptojs/components/enc-utf16-min.js"></script>
<script src="libraries/cryptojs/rollups/sha1.js"></script>
<script src="libraries/cryptojs/rollups/aes.js"></script>
<script src="libraries/cryptojs/rollups/md5.js"></script>
<script src="libraries/cryptojs/rollups/hmac-sha1.js"></script>
<script src="libraries/localStorageDB/localstoragedb.min.js"></script>
<script src="libraries/jqGrid-4.5.4/js/jquery.jqGrid.min.js"></script>
<script src="libraries/jqGrid-4.5.4/js/i18n/grid.locale-en.js"></script>
<script src="libraries/three.min.js"></script>
<script src="libraries/dynatree/jquery.dynatree.min.js"></script>
<script src="libraries/jqplot/jquery.jqplot.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.barRenderer.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.categoryAxisRenderer.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.pointLabels.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.pieRenderer.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.donutRenderer.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.dateAxisRenderer.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.json2.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.meterGaugeRenderer.min.js"></script>
<script src="libraries/jqplot/plugins/jqplot.highlighter.min.js"></script>
<script src="libraries/loki-js/lokijs.js"></script>
<script src="libraries/codemirror/lib/codemirror.js"></script>
<script src="libraries/codemirror/mode/xml/xml.js"></script>
<script src="libraries/codemirror/mode/javascript/javascript.js"></script>
<script src="libraries/codemirror/mode/htmlmixed/htmlmixed.js"></script>
<script src="libraries/codemirror/mode/css/css.js"></script>
<script src="libraries/codemirror/mode/clike/clike.js"></script>
<script src="libraries/codemirror/mode/markdown/markdown.js"></script>
<script src="libraries/codemirror/mode/dtd/dtd.js"></script>
<script src="libraries/codemirror/mode/coffeescript/coffeescript.js"></script>
<script src="libraries/codemirror/mode/python/python.js"></script>
<script src="libraries/codemirror/mode/cypher/cypher.js"></script>
<script src="libraries/codemirror/addon/display/fullscreen.js"></script>
<script src="libraries/codemirror/addon/fold/foldcode.js"></script>
<script src="libraries/codemirror/addon/fold/foldgutter.js"></script>
<script src="libraries/codemirror/addon/fold/brace-fold.js"></script>
<script src="libraries/codemirror/addon/fold/xml-fold.js"></script>
<script src="libraries/codemirror/addon/fold/markdown-fold.js"></script>
<script src="libraries/codemirror/addon/fold/comment-fold.js"></script>
<script src="libraries/codemirror/addon/edit/closetag.js"></script>
<link rel="stylesheet" href="libraries/codemirror/addon/dialog/dialog.css">
<script src="libraries/codemirror/addon/dialog/dialog.js"></script>
<script src="libraries/codemirror/addon/search/searchcursor.js"></script>
<script src="libraries/codemirror/addon/search/search.js"></script>
<link rel="stylesheet" href="libraries/codemirror/addon/fold/foldgutter.css" />
<script src="libraries/nicEdit/nicEdit.js"></script>
<script src="libraries/prettyprint/prettyprint.js"></script>
<script src="libraries/shortcut.js"></script>
<script src="libraries/MetroJs.Full.0.9.74/MetroJs.js"></script>
<script src="libraries/math.min.js"></script>
<script src="libraries/easeljs/easeljs-0.7.1.min.js"></script>
<script src="libraries/pixi.js/pixi.js"></script>
<script src="libraries/springy/springy.js"></script>
<script src="libraries/springy/springyui.js"></script>
<script src="libraries/nedb/nedb.min.js"></script>
<script src="libraries/obeliskjs/obelisk.js"></script>
<script src="libraries/buckets/buckets-minified.js"></script>
<script src="libraries/textillate/jquery.fittext.js"></script>
<script src="libraries/textillate/jquery.lettering.js"></script>
<script src="libraries/textillate/jquery.textillate.js"></script>
<script src="libraries/filesaver/FileSaver.js"></script>
<script src="libraries/tinymce/tinymce.min.js"></script>
<script src="libraries/indexed.js"></script>
<script src="libraries/moment.min.js"></script>
<script src="libraries/babylon.js/babylon.1.11.js"></script>
<script src="libraries/json-editor/jsoneditor.js"></script>
<script src="libraries/d3/d3.min.js"></script>
<link rel="stylesheet" href="libraries/tinymce/skins/lightgray/skin.min.css">
<link rel="stylesheet" href="libraries/textillate/animate.css">
<link rel="stylesheet" href="libraries/MetroJs.Full.0.9.74/MetroJs.css">
<link rel="stylesheet" href="libraries/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="libraries/codemirror/addon/display/fullscreen.css">
<link rel="stylesheet" href="libraries/codemirror/theme/night.css">
<link rel="stylesheet" href="libraries/codemirror/theme/3024-day.css">
<link rel="stylesheet" href="libraries/codemirror/theme/3024-night.css">
<link rel="stylesheet" href="libraries/codemirror/theme/ambiance.css">
<link rel="stylesheet" href="libraries/codemirror/theme/ambiance-mobile.css">
<link rel="stylesheet" href="libraries/codemirror/theme/base16-dark.css">
<link rel="stylesheet" href="libraries/codemirror/theme/base16-light.css">
<link rel="stylesheet" href="libraries/codemirror/theme/blackboard.css">
<link rel="stylesheet" href="libraries/codemirror/theme/cobalt.css">
<link rel="stylesheet" href="libraries/codemirror/theme/eclipse.css">
<link rel="stylesheet" href="libraries/codemirror/theme/elegant.css">
<link rel="stylesheet" href="libraries/codemirror/theme/erlang-dark.css">
<link rel="stylesheet" href="libraries/codemirror/theme/lesser-dark.css">
<link rel="stylesheet" href="libraries/codemirror/theme/mbo.css">
<link rel="stylesheet" href="libraries/codemirror/theme/midnight.css">
<link rel="stylesheet" href="libraries/codemirror/theme/monokai.css">
<link rel="stylesheet" href="libraries/codemirror/theme/neat.css">
<link rel="stylesheet" href="libraries/codemirror/theme/neo.css">
<link rel="stylesheet" href="libraries/codemirror/theme/night.css">
<link rel="stylesheet" href="libraries/codemirror/theme/paraiso-dark.css">
<link rel="stylesheet" href="libraries/codemirror/theme/paraiso-light.css">
<link rel="stylesheet" href="libraries/codemirror/theme/pastel-on-dark.css">
<link rel="stylesheet" href="libraries/codemirror/theme/rubyblue.css">
<link rel="stylesheet" href="libraries/codemirror/theme/solarized.css">
<link rel="stylesheet" href="libraries/codemirror/theme/the-matrix.css">
<link rel="stylesheet" href="libraries/codemirror/theme/tomorrow-night-eighties.css">
<link rel="stylesheet" href="libraries/codemirror/theme/twilight.css">
<link rel="stylesheet" href="libraries/codemirror/theme/vibrant-ink.css">
<link rel="stylesheet" href="libraries/codemirror/theme/xq-dark.css">
<link rel="stylesheet" href="libraries/codemirror/theme/xq-light.css">
<link rel="stylesheet" type="text/css" href="libraries/jqplot/jquery.jqplot.css" />
<link rel="stylesheet" type="text/css" href="libraries/dynatree/skin/ui.dynatree.css" />
<link rel="stylesheet" type="text/css" href="libraries/jqGrid-4.5.4/css/ui.jqgrid.css" />
<link rel="stylesheet" type="text/css" href="libraries/alertify.js-0.3.11/themes/alertify.core.css" />
<link rel="stylesheet" type="text/css" href="libraries/alertify.js-0.3.11/themes/alertify.bootstrap.css" />
<link rel="stylesheet" type="text/css" href="libraries/font-awesome/css/font-awesome.css"/>

<style>
@font-face{
	font-family: "heorot";
	src: url('fonts/heorot.ttf'),
	url('fonts/heorot.ttf');
}

body {
	margin: 0;
}

a.TridentLink:link
{
    color: #FFFF99;
    text-decoration: none;
	font-size: 20pt;
}

a.TridentLink:hover
{
    text-decoration: underline;
    color: #FFFF99;
}

a.TridentLink:visited
{
    color: #FFFF99;
}

a.TridentLinkSmall:link
{
    color: #FFFF99;
    text-decoration: none;
	font-size: 14pt;
}

a.TridentLinkSmall:hover
{
    text-decoration: underline;
    color: #FFFF99;
}

a.TridentLinkSmall:visited
{
    color: #FFFF99;
}

img.TridentImageButton:hover
{
	style.opacity:0.6;
}
	
button.TridentButton
{
	background-color: #ddd;
	color: #000;
	min-width:10px;
	letter-spacing: 0em;
}

button.TridentButton:hover
{
	background-color: #fff;
	color: #000;
}

button.ui_btn_launch
{
	background-color: #ddd;
	color: #000;
	min-width:10px;
}

button.ui_btn_launch:hover
{
	background-color: #fff;
	color: #000;
}

button.ui_show_dashboard
{
	background-color: #ddd;
	color: #000;
	min-width:10px;
}

button.ui_show_dashboard:hover
{
	background-color: #fff;
	color: #000;
}

button.ui_browse_samples
{
	background-color: #ddd;
	color: #000;
	min-width:10px;
}

button.ui_browse_samples:hover
{
	background-color: #fff;
	color: #000;
}

button.ui_gen_sa
{
	background-color: #ddd;
	color: #000;
	min-width:10px;
}

button.ui_gen_sa:hover
{
	background-color: #fff;
	color: #000;
}

div.UI_MainPlaceholder 
{
	background-color: #444;
}

</style>

<script>
	var showMarkup = true;
	var showScript = true;
	var sb_split_mode = 0; // Determines if split mode for editors is side-by-side (0) or top-bottom (1)
	
	var sb_flashtabtext = false;
	var sb_flashtabhtml = false;
	var sb_lastconsolecmd = "";
	
	var sb_appcache_progress = 0;
	
	// Set up pseudo enum to indicate the editor mode
	var EditorModeEnum = Object.freeze({"Markup":1, "Split":2, "Script":3 });
	var editorMode = EditorModeEnum.Split;
	
	// retain global references to codemirror objects set later
	var editorMarkup, editorScript;

	//	API VARIABLES 
	var VAR_UserFileValue = "";
	var VAR_WindowMode = 2;
	var VAR_TRIDENT_VERSION = 1.96;
	var VAR_TRIDENT_HOSTED = false;
	var VAR_TRIDENT_APPCACHED = false;
	var VAR_TRIDENT_ONLINE = function() { return navigator.onLine; }
	var VAR_TRIDENT_ENV_TYPE = 'IDE WJS'; // IDE, STANDALONE, SBL
	var VAR_TRIDENT_DB = null;
	var VAR_TRIDENT_API = null;
	var VAR_ForceOnlineSamples = true;
	var VAR_UI_Settings = {
		header_text : "",
		header_font : "",
		editor_theme : "vibrant-ink",
		skip_autorun : false,
		error_popups : true,
		pend_changes_warn : true
	}

	// possibly hash script and markup to determine if changes have been made 
	var sb_markup_hash = null;
	var sb_script_hash = null;
	
	$(document).ready(function() {
		// I dont want to allow this to run in an iframe
		if(location.href != top.location.href) {
			document.body.innerHTML = "Trident Sandbox does not run in an IFRAME";
			return;
		}
		
		// Help user quickly identify errors in their code by displaying alert with msg, line and col
		window.onerror = function(msg, url, line, col, error) {
			if (!VAR_UI_Settings.error_popups) return;
			
			alertify.error(msg + " (line " + line + " col " + col + ")");
			API_LogMessage(msg + " (line " + line + " col " + col + ")");
		};
		
		// Fix for IE 10 and possibly IE 11 (on 8.1 update 0)
		// Needed for Crypto.JS to work properly with typearray lib
		if (typeof Uint8ClampedArray == "undefined") {
            Uint8ClampedArray = Uint8Array;
        }
		
		alertify.set({ buttonReverse: true });
		$("#UI_TabsOutput").tabs();
		$("#UI_TabsDashboard").tabs();
		$("#sb_radioset").buttonset();
		
		//$('.tlt').textillate({ in: { effect: 'rollIn' } });
		
		$('#UI_TabsDashboard').on('tabsactivate', function(event, ui) {
			var newIndex = ui.newTab.index();
			switch (newIndex){
				case 0: sb_dashboard.calcSummaryUsage(); break;
				case 1: sb_dashboard.calcLocalStorageUsage(); break;
				case 2: sb_dashboard.calcTridentDbUsage(); break;
			}
		});
		
		// For some reason IE sometimes 'remembers' this val across loads
		$("#sb_txt_ProgramName").val("");
		
		// Set up some keyboard shortcuts
		shortcut.add("Alt+R", function() { sb_run(); } );
		shortcut.add("Alt+S", function() { if (indexedDB) { sb_save_slot(); } else { sb_save(); } } );
		shortcut.add("Alt+Q", function() { if (editorMode == EditorModeEnum.Markup) sb_toggle_split(); else sb_toggle_markup(); } );
		shortcut.add("Alt+W", function() { if (editorMode == EditorModeEnum.Script) sb_toggle_split(); else sb_toggle_script(); } );
		shortcut.add("Alt+I", function() { sb_inspect(); } );
		shortcut.add("Alt+1", function() { API_SetWindowMode(1); } );
		shortcut.add("Alt+2", function() { API_SetWindowMode(2); } );
		shortcut.add("Alt+3", function() { API_SetWindowMode(3); } );
		
		// While waiting for user to click the allow scripts button, we hid some ugly UI elements,
		// so now scripts are enabled un-hide the code elements and clear our warning/notice log message.
		$("#divCode").css("display", "block");
		API_ClearLog();
		
		document.title = "Trident Sandbox WJS v" + VAR_TRIDENT_VERSION;
		$("#sb_txt_Markup").val("<!-- \r\nWelcome to TridentSandbox v" + VAR_TRIDENT_VERSION + "\r\n\r\nF11 : (while in an editor) will toggle fullscreen editing.\r\nESC : will also exit fullscreen mode. \r\nAlt+R : Run\r\nAlt+L : If Hosted/AppCached, Save and Launch in new Window\r\nAlt+S : Save\r\nAlt+Q : Toggle Markup\r\nAlt+W : Toggle Script\r\nAlt+I : Inspect\r\nAlt+1/2/3 : Switch between the three window modes\r\nCtrl+Q : Within an editor (on a code fold line) will toggle fold\r\nCtrl-F : Find text (In editor this will do basic search)\r\nCtrl-G : Find next\r\nShift-Ctrl-F : Replace\r\nShift-Ctrl-R : Replace All\r\n-->");
		
		// ugly but lenient feature detection for Displaying Browse Samples button
		// if served up from anywhere other than filesystem ... show
		// if served up from filesystem and localStorage is available... show 
		// Mozilla supports ajax calls under filesystem
		if (document.URL.indexOf("file://") == -1 || localStorage || indexedDB) {
			$(".ui_show_dashboard").show();
			$(".ui_btn_launch").show();
			$(".ui_gen_sa").hide();	// no need to generate standalone if hosted/appcached
			shortcut.add("Alt+L", function() { sb_launch(); } );
		}
		else {
			$("#sb_div_diagnostic").hide();
		}

		// We are keeping track of whether the user has pending changes via a Crypto.JS hash on the markup and script
		// This will now calculate the initial value based on our Welcome text above
		sb_markup_hash = CryptoJS.SHA1($("#sb_txt_Markup").val()).toString();
		sb_script_hash = CryptoJS.SHA1("").toString();
		
		// CHANGE THEME name Here look at the stylesheets above to get the name
		var themeName = "vibrant-ink";

		// We are using xml mode for markup so that if we add style tag it wont mess up rendering
		// hopefully in the future we can implement mixed rendering or add separate css
		editorMarkup = CodeMirror.fromTextArea(document.getElementById("sb_txt_Markup"), {
			smartIndent: false,
	        autoCloseTags: true,
			lineNumbers: true,
			theme: themeName,
			mode: "htmlmixed",
			foldGutter: true,
			gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
			extraKeys: {
				"Ctrl-Q": function(cm) { 
					cm.foldCode(cm.getCursor()); 
				},
				"F11": function(cm) {
					cm.setOption("fullScreen", !cm.getOption("fullScreen"));
				},
				"Esc": function(cm) {
					if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
				}
			}
		});

		editorScript = CodeMirror.fromTextArea(document.getElementById("sb_txt_Script"), {
			smartIndent: false,
			lineNumbers: true,
			theme: themeName,
			mode: "javascript",
			foldGutter: true,
			gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
			extraKeys: {
				"Ctrl-Q": function(cm) { 
					cm.foldCode(cm.getCursor()); 
				},
				"F11": function(cm) {
					cm.setOption("fullScreen", !cm.getOption("fullScreen"));
				},
				"Esc": function(cm) {
					if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
				}
			}
		});

		var themeParam = API_GetURLParameter("Theme");
		if (themeParam != null && themeParam != "") {
			$("#selTheme option").filter(function() {
				return $(this).text() == themeParam; 
			}).prop('selected', true);
			editorMarkup.setOption("theme", themeParam);
			editorScript.setOption("theme", themeParam);
		}
		
		var localsar = false;
		var localrun = null;
		
		if (localStorage) {
			var theme = localStorage["editor-theme"]; 
			if (theme != null && theme != "") {
				VAR_UI_Settings.editor_theme = theme;
				
				$("#selTheme option").filter(function() {
					return $(this).text() == theme; 
				}).prop('selected', true);
				//localStorage["editor-theme"] = theme;
				editorMarkup.setOption("theme", theme);
				editorScript.setOption("theme", theme);
			}
			else {
				localStorage["editor-theme"] = "vibrant-ink";
			}
			
			var headerFont = localStorage["header-font"];
			if (headerFont != null && headerFont != "") {
				VAR_UI_Settings.header_font = headerFont;
				
				$('#sb_header_caption').css("font-family", headerFont);
				$('#sb_header_caption2').css("font-family", headerFont);
			}
			else {
				localStorage["header-font"] = "Heorot";
			}
			
			var headerText = localStorage["header-text-wjs"];
			if (headerText != null && headerText != "") {
				VAR_UI_Settings.header_text = headerText;
				
				$('#sb_header_caption').text(headerText);
				$('#sb_header_caption2').text(headerText);
			}
			else {
				localStorage["header-text-wjs"] = $('#sb_header_caption').text();
			}
			
			$('.tlt').textillate();	// need to run effect after text is set
		
			var sar = localStorage["skip-autorun"];
			if (sar != null && sar != "") {
				if (sar == "true") {
					VAR_UI_Settings.skip_autorun = sar;
					localsar = true;
				}
			}
			else {
				localStorage["skip-autorun"] = "false";
			}
			
			var errorPopups = localStorage["error-popups"];
			if (errorPopups != null && errorPopups != "") {
				VAR_UI_Settings.error_popups = (errorPopups == "true");
			}
			else {
				localStorage["error-popups"] = "true";
			}
			
			var pcWarn = localStorage["pend-changes-warn"];
			if (pcWarn != null && pcWarn != "") {
				VAR_UI_Settings.pend_changes_warn = (pcWarn == "true");
			}
			else {
				localStorage["pend-changes-warn"] = "true";
			}
			
			var lr = localStorage["run-slot"];
			if (lr != null && lr != "") {
				localrun = lr;
			}
		}
		else {
			$('.tlt').textillate();
		}
		
		sb_fit_log();
		sb_fit_editors();
		
		if (localStorage) {
			$("#sb_spn_localstorage_status").text("Yes");
			$("#ui_show_dashboard").show();
		}
		
		$(window).resize(function() {
			sb_fit_log();
			sb_fit_editors();
			
			// Allow User Programs to receive window resize events
			// by implementing this callback
			if (typeof(EVT_WindowResize) == typeof(Function)) EVT_WindowResize();
		});
		
		// Check for indexed db support and set up new TridentSandbox DB with simple app/key/value Object Store (Table) for internal and api use
		// For good tutorial on indexedDB, see http://code.tutsplus.com/tutorials/working-with-indexeddb--net-34673
		if (indexedDB) {
			$("#sb_spn_indexeddb_status").text("Yes");
			$("#sb_div_ls_slots").css("display", "inline-block");
			
			var openRequest = indexedDB.open("TridentSandboxDB", 1);
 
			// If database doesnt exist yet or its version is lower than our version specified above (2nd param in line above)
			openRequest.onupgradeneeded = function(e) {
				var thisDB = e.target.result;
				if (thisDB.objectStoreNames.contains("TridentSandboxKVP")) {
					thisDB.deleteObjectStore("TridentSandboxKVP");
				}
				
				if(!thisDB.objectStoreNames.contains("TridentSandboxKVP")) {
					var objectStore = thisDB.createObjectStore("TridentSandboxKVP", { keyPath: "id", autoIncrement:true });
					objectStore.createIndex("app","app", {unique:false});
					objectStore.createIndex("key","key", {unique:false});
					// hack to simulate composite key since overhead is low (main size should be in val field)
					// user (me) required to duplicate the app and key into comma delimited appkey field off object
					// This will allow retrieving single record with that composite key as well as 
					// still supporting opening cursors on app or key alone
					objectStore.createIndex("appkey", "appkey", {unique:true});
				}
				
				API_LogMessage("Upgrading...");
			}
 
			openRequest.onsuccess = function(e) {
				API_LogMessage("TridentSandboxDB (indexedDB) opened.");
				VAR_TRIDENT_DB = e.target.result;
				
				// To be future-proof you can code against the new VAR_TRIDENT_API
				// It lets you switch between old indexedDb TridentDatabase
				// and a web service implementation to run on your own private 'cloud'
				// You can switch between the two dynamically.
				VAR_TRIDENT_API = new TridentDatabase(VAR_TRIDENT_DB, function() {
					if (VAR_TRIDENT_API.mode == "trident") {
						$("#sb_spn_indexeddb_status").text("Yes");
					}
					else {
						$("#sb_spn_indexeddb_status").html("Yes <span style='font-family:Symbol'>Å</span>");
					}
					
					sb_refresh_slots();	// when user changes from local to web, refresh slots
					
					if (typeof(EVT_TridentChanged) == "function") EVT_TridentChanged();
				});
				
				if (VAR_TRIDENT_API.mode == "trident") {
					$("#sb_spn_indexeddb_status").text("Yes");
				}
				else {
					$("#sb_spn_indexeddb_status").html("Yes <span style='font-family:Symbol'>Å</span>");
				}
					
				var skipautorun = API_GetURLParameter("SkipAutorun");
				if (skipautorun == null && !localsar) {
					sb_run_autorun();
				}
				
				// Now that not only is indexed db available but the Trident database is opened, handle url LoadSlot/RunSlot hash params
				sb_refresh_slots(function() {
				
					var loadSlot = API_GetURLParameter("LoadSlot");
					if (loadSlot != null) {
						sb_clean_sandbox();
						
						$("#sb_sel_trident_slot").val(loadSlot);
						
						// let sandbox finish cleaning then load
						setTimeout(function() {
							sb_load_slot();
						}, 200);
					}
					else {
						var runSlot = API_GetURLParameter("RunSlot");
						if (runSlot != null || localrun != null) {
							sb_clean_sandbox();
						
							if (localrun != null)	$("#sb_sel_trident_slot").val(localrun);
							else					$("#sb_sel_trident_slot").val(runSlot);

							// let sandbox finish cleaning then run
							setTimeout(function() {
								sb_load_slot(true);
							}, 200);
						}
						else {
							var runSample = API_GetURLParameter("RunSample");
							if (runSample != null) {
								sb_clean_sandbox();
								
								setTimeout(function() {
									sb_run_sample(runSample);
								}, 200);
							}
						}
					}
				
				});
			}
 
			openRequest.onerror = function(e) {
				API_LogMessage("Error opening TridentSandboxDB (indexedDB).");
				API_Inspect(e);
			}
			
			// Detect Hash Param changes for loadslot/runslot; (compare to txtProgramName or SaveSlotSelect?)
			window.onhashchange = function() {
				var loadSlot = API_GetURLParameter("LoadSlot");
				if (loadSlot != null && loadSlot != $("#txtProgramName").val()) {
					sb_clean_sandbox();
					
					$("#sb_sel_trident_slot").val(loadSlot);
					
					// let sandbox finish cleaning then load
					setTimeout(function() {
						sb_load_slot();
					}, 250);
				}
				else {
					var runSlot = API_GetURLParameter("RunSlot");
					if (runSlot != null && runSlot != $("#txtProgramName").val()) {
						sb_clean_sandbox();
					
						$("#sb_sel_trident_slot").val(runSlot);

					// let sandbox finish cleaning then run
						setTimeout(function() {
							sb_load_slot(true);
						}, 250);
					}
					else {
						var runSample = API_GetURLParameter("RunSample");
						if (runSample != null) {
							sb_clean_sandbox();
							
							setTimeout(function() {
								sb_run_sample(runSample);
							}, 200);
						}
					}
				}
			}
			
		}
		
		// If served up from a website then we should bother to monitor possible appcache events
		// for diagnostics.  If not appcaching the events will just not fire.
		if (document.URL.indexOf("file://") == -1) {
			VAR_TRIDENT_HOSTED = true;

			// Determine if we are connecting or running from an appcache site
			var appCache = window.applicationCache;
			if (window.applicationCache) {
					appCache.addEventListener('error', logACEvent, false);
					appCache.addEventListener('checking', logACEvent, false);
					appCache.addEventListener('noupdate', logACEvent, false);
					appCache.addEventListener('downloading', logACEvent, false);
					appCache.addEventListener('progress', progressAC, false);
					appCache.addEventListener('updateready', logACEvent, false);
					appCache.addEventListener('cached', logACEvent, false);
			}
		}
		
		// Register Event Handler to warn if leaving page
		window.onbeforeunload = function(e) {
			// Get Hash of current editor contents to compare with last 'load' or 'new
			// If they are different (user made changes) then warm them when they are leaving the page.  
			var htmlHash = CryptoJS.SHA1(editorMarkup.getValue()).toString();
			var scriptHash = CryptoJS.SHA1(editorScript.getValue()).toString();
			
			if ((htmlHash != sb_markup_hash || scriptHash != sb_script_hash) && VAR_UI_Settings.pend_changes_warn) {
				return 'You have unsaved changes, are you sure you want to leave this page?';
			}
		};
		
	});
	
	function applyUiSettings() {
		editorMarkup.setOption("theme", VAR_UI_Settings.editor_theme);
		editorScript.setOption("theme", VAR_UI_Settings.editor_theme);
	
		if (VAR_UI_Settings.header_text != "") {
			$('#sb_header_caption').text(VAR_UI_Settings.header_text);
			$('#sb_header_caption2').text(VAR_UI_Settings.header_text);
		}
		
		if (VAR_UI_Settings.header_font != "") {
			$('#sb_header_caption').css("font-family", VAR_UI_Settings.header_font);
			$('#sb_header_caption2').css("font-family", VAR_UI_Settings.header_font);
		}
	}
	
	function progressAC(e)
	{
		sb_appcache_progress++;
		
		// hardcoding total # files
		$("#sb_spn_appcache_progress").text("(" + Math.floor(sb_appcache_progress*100/344) + "%)");
	}
	
	// Helper method for appcache diagnostic
	function logACEvent(e)
	{
		VAR_TRIDENT_APPCACHED = true;  // if any of the events fire we will assume it is successful and running in appcached mode

		// Update diagnostic panel
		var statusString = getACStatus();
		$("#sb_spn_appcache_status").text(statusString);
		
		if (statusString == "Update ready") {
			$("#sb_spn_appcache_progress").text(""); 
			setTimeout(function() {
				sb_prompt_update();
			}, 200);
		}
	}

	// Helper method for appcache diagnostics, this event will be fired whenever appcache status changes
	function getACStatus()
	{
		try{
			var sCacheStatus = "Not supported";
			if (window.applicationCache) 
			{
				var oAppCache = window.applicationCache;
				switch ( oAppCache.status ) 
				{
					case oAppCache.UNCACHED : sCacheStatus = "Not cached"; break;
					case oAppCache.IDLE : sCacheStatus = "Idle"; $("#sb_spn_appcache_progress").text(""); sb_fit_editors(); break;
					case oAppCache.CHECKING : sCacheStatus = "Checking"; break;
					case oAppCache.DOWNLOADING : sCacheStatus = "Downloading"; break; 
					case oAppCache.UPDATEREADY : sCacheStatus = "Update ready"; break;
					case oAppCache.OBSOLETE : sCacheStatus = "Obsolete"; break;
					default : sCacheStatus = "Unexpected Status ( " + oAppCache.status.toString() + ")"; break;
				}
			}
			return sCacheStatus;
		}
		catch (e)
		{
			alertify.log(e);
			API_LogMessage(e);
		}
	}
	
	function sb_prompt_update() {
		alertify.confirm("An update exists to your AppCache install.  Do you want to install it and reload this page?", function (e) {
    		if (e) {
        		// user clicked "ok"
              	applicationCache.swapCache();
				location.reload(); 
    		} else {
        		// user clicked "cancel"
            }
		});
	}

// SANDBOX I/O ROUTINES  
	function sb_loaded(evt) {
		var filestring = evt.target.result;
		
		var sandboxObject = JSON.parse(filestring);
		
		$("#sb_txt_ProgramName").val(sandboxObject.progName);

		sb_markup_hash = CryptoJS.SHA1(sandboxObject.htmlText).toString();
		sb_script_hash = CryptoJS.SHA1(sandboxObject.scriptText).toString();
		
		editorMarkup.setValue(sandboxObject.htmlText);
		editorScript.setValue(sandboxObject.scriptText);

		// IE's HTML 5 file control seems to place a lock on the last loaded file which
		// was interfering with the saving and overwriting of that same file.
		// So i will reset it by destroying and recreating, allowing the GC to release
		// any old file locks.
		var control = $("#sb_file");
		control.replaceWith( control = control.clone( true ) );
		
	}
	
	function errorHandler(evt) {
		alertify.error('load error');
	}
	
	function sb_load() {
		// use most thorough method for cleaning sandbox
		sb_clean_sandbox();
		
		var file = document.getElementById('sb_file').files[0];
		if(file) {
			var reader = new FileReader();

			reader.readAsText(file, "UTF-8");

			// Handle progress, success, and errors
			//reader.onprogress = updateProgress;
			reader.onload = sb_loaded;
			reader.onerror = errorHandler;
		}
	}
	
	function sb_save() {
		var prgName = $("#sb_txt_ProgramName").val();
		if (prgName == "") {
			alertify.error("You need to enter a program name first");
			return;
		}
		
		// The File Loaders seem to place a lock on the file so, in the event they are saving to the same filename,
		// lets clear out the old file control so that (if they save to the same filename as they last loaded) it will work.
		// The actual save still waits on user input to handle the save, so no need to setTimeout
		var control = $("#sb_file");
		control.replaceWith( control = control.clone( true ) );
		
		var progNameString = prgName;
		var htmlTextString = editorMarkup.getValue();
		var scriptTextString = editorScript.getValue();
		
		sb_markup_hash = CryptoJS.SHA1(htmlTextString).toString();
		sb_script_hash = CryptoJS.SHA1(scriptTextString).toString();

		var sandboxObject = { progName: progNameString, htmlText: htmlTextString, scriptText: scriptTextString };
		
		var json_text = JSON.stringify(sandboxObject, null, 2);
		
		// Both IE and polyfill methods seem to rely on blobs
		if (typeof Blob == "undefined") {
			alert('no blobs available (incompatible browser?)');
			return;
		}
		
		// if ms specific (ie) method msSaveBlob is not present then use the polyfill filesaver.js functionality
		if (window.navigator.msSaveBlob === undefined) {
			var blob = new Blob([json_text], {type: "application/octet-stream"});
			saveAs(blob, progNameString + ".prg");
		}
		else {
			var blob1 = new Blob([json_text]);
			window.navigator.msSaveBlob(blob1, progNameString + ".prg");
		}
	}

	function sb_user_hide_load() {
		$("#sb_div_userfile").hide();
	}
	
	// event handler
	function sb_user_file_loaded(evt) {
		var filename = $("#sb_user_file").val().replace(/^.*[\\\/]/, '');

		var filestring = evt.target.result;
	
		// store in global API var in case they haven't set up async callback
		VAR_UserFileValue = filestring;
		
		// IE's HTML 5 file control seems to place a lock on the last loaded file which
		// was interfering with the saving and overwriting of that same file.
		// So I will reset it by destroying and recreating, allowing the GC to release
		// any old file locks.
		var control = $("#sb_user_file");
		control.replaceWith( control = control.clone( true ) );
		
		API_HideUserLoader();
		
		// If user has registered a callback function (for when load is completed), call it
		if (typeof(EVT_UserLoadCallback) == typeof(Function)) {
			// Give time for the file control replace (done above) to complete
			// before giving the user a chance to interfere with that process
			setTimeout(function() {
				EVT_UserLoadCallback(filestring, filename);
			}, 250);
		}
	}
	
	function sb_user_datafile_loaded(evt) {
		var filename = $("#sb_user_datafile").val().replace(/^.*[\\\/]/, '');

		// IE's HTML 5 file control seems to place a lock on the last loaded file which
		// was interfering with the saving and overwriting of that same file.
		// So I will reset it by destroying and recreating, allowing the GC to release
		// any old file locks.
		
		var control = $("#sb_user_datafile");
		control.replaceWith( control = control.clone( true ) );
		
		API_HideUserDataLoader();
		
		// If user has registered a callback function (for when load is completed), call it
		if (typeof(EVT_UserDataLoadCallback) == typeof(Function)) {
			// Give time for the file control replace (done above) to complete
			// before giving the user a chance to interfere with that process
			setTimeout(function() {
				EVT_UserDataLoadCallback(evt.target.result, filename);
			}, 250);
		}
	}
	
	// event handler
	function sb_user_load()	{
		var file = document.getElementById('sb_user_file').files[0];
		if(file) {
			var reader = new FileReader();

			reader.readAsText(file, "UTF-8");

			// Handle progress, success, and errors
			//reader.onprogress = updateProgress;
			reader.onload = sb_user_file_loaded;
			reader.onerror = errorHandler;
		}
	}
	
	function sb_restore_load() {
		var file = document.getElementById('sb_restore_file').files[0];
		if(file) {
			var reader = new FileReader();

			reader.readAsText(file, "UTF-8");

			// IE's HTML 5 file control seems to place a lock on the last loaded file which
			// was interfering with the saving and overwriting of that same file.
			// So I will reset it by destroying and recreating, allowing the GC to release
			// any old file locks.
			var control = $("#sb_restore_file");
			control.replaceWith( control = control.clone( true ) );

			// Handle progress, success, and errors
			//reader.onprogress = updateProgress;
			reader.onload = function(evt) {
				var loadString = evt.target.result;

				var keyArray = JSON.parse(loadString);
				for(i=0; i<keyArray.length; i++) {
					var app = keyArray[i].app;
					var key = keyArray[i].key;
					var val = keyArray[i].val;

					VAR_TRIDENT_API.SetAppKey(app, key, val);
				}
				
				// In case the restore contained new Trident Save Slots, refresh the list
				sb_refresh_slots();
				
				alertify.success("Restore Completed");
			};
			reader.onerror = errorHandler;
		}
	}
	
	function sb_user_dataload() {
		var file = document.getElementById('sb_user_datafile').files[0];
		if(file) {
			var reader = new FileReader();

			reader.readAsDataURL(file, "UTF-8");

			// Handle progress, success, and errors
			//reader.onprogress = updateProgress;
			reader.onload = sb_user_datafile_loaded;
			reader.onerror = errorHandler;
		}
	}
	
	function sb_loadtemplate() {
		alertify.confirm("This will un-hide a file picker you use to pick the the SandboxLoader.htm file at the root of your Trident Sandbox Installation.  Once you do this it will generate and prompt to save a standalone htm version of the program currently loaded.  Continue?", function (e) {
			if (e) {
				// user clicked "ok"
				$("#sb_div_compile_standalone").show();
			}
		});
	
	}
	
	function sb_template_loaded(evt) {
		var templateString = evt.target.result;
		var htmlString = editorMarkup.getValue();
		var scriptString = editorScript.getValue();
		
		templateString = templateString.replace("<!--TRIDENT_HTML-->", htmlString);
		templateString = templateString.replace("/*TRIDENT_SCRIPT*/", scriptString);
	
		if (typeof Blob == "undefined") {
			alert('no blobs available (incompatible browser?)');
		}
		else {
			var blob1 = new Blob([templateString]);
			window.navigator.msSaveBlob(blob1, $("#sb_txt_ProgramName").val() + ".htm");
		}

		var control = $("#sb_file_template");
		control.replaceWith( control = control.clone( true ) );
		
		setTimeout(function() {
			$("#sb_div_compile_standalone").hide();
		}, 200);
	}

	// The intent behind this function is for the person hosting this app (or me for now) can put up samples dynamically between builds to share
	// to public as sort of a published jsfiddle.  So it automates a not-frequently or official sample... so it is efficient way to for me to link to sample not
	// necessary for user to bookmark for long term... if they want to keep the prog they should save it and use runslot for long term bookmarking.
	// As such we will turn off caching to force server visit, this will bypass appcache due to extra url params jquery passes to ensure not cached.
	function sb_run_sample(progname) {
		progname = progname.replace("%20", " ");	// handle encoded spaces
		progname = progname.replace(/[^a-zA-Z 0-9]+/g, ""); // whitelist alphanumeric
		progname = "samples\\" + progname + ".prg";	// force extension
		
		jQuery.ajax({
			type: "GET",
			url: progname,
			cache: false,
			dataType: "json",

			success: function (response) {
				var sandboxObject = response;
	
				$("#sb_txt_ProgramName").val(sandboxObject.progName);

				editorMarkup.setValue(sandboxObject.htmlText);
				editorScript.setValue(sandboxObject.scriptText);
				
				sb_markup_hash = CryptoJS.SHA1(sandboxObject.htmlText).toString();
				sb_script_hash = CryptoJS.SHA1(sandboxObject.scriptText).toString();

				// IE's HTML 5 file control seems to place a lock on the last loaded file which
				// was interfering with the saving and overwriting of that same file.
				// So I will reset it by destroying and recreating, allowing the GC to release
				// any old file locks.
				var control = $("#sb_file");
				control.replaceWith( control = control.clone( true ) );
			
				// if editors dont reflect current source when we change back to a source visible window mode 
				// then we may need to setTimeout on the following two lines to give editors a chance to update display 
				API_SetWindowMode(3);
				
				sb_run();
			},
			error: function (xhr, ajaxOptions, thrownError) {
				API_LogMessage("If you are hosting this on your own server, make sure to add mime type for .prg files as text/json");
				API_LogMessage(xhr.status + " : " + xhr.statusText);
				alertify.log(xhr.status + " : " + xhr.statusText);
				alertify.log("See user log for more info");
			}
		});
	}
	
	function sb_browse_samples_action() {
		var baseUrl = "";

		if (VAR_ForceOnlineSamples) {
			baseUrl = "http://www.obeliskos.com/TridentSandbox/";
			alertify.log("Accessing Online Samples Browser");
		}
		setTimeout(function() {
			var url = baseUrl + "samples/Hosted Samples Browser.prg";

			jQuery.ajax({
				type: "GET",
				url: url,
				//cache: false,
				dataType: "json",

				success: function (response) {
					var sandboxObject = response;
		
					$("#sb_txt_ProgramName").val(sandboxObject.progName);

					editorMarkup.setValue(sandboxObject.htmlText);
					editorScript.setValue(sandboxObject.scriptText);
					
					sb_markup_hash = CryptoJS.SHA1(sandboxObject.htmlText).toString();
					sb_script_hash = CryptoJS.SHA1(sandboxObject.scriptText).toString();

					// IE's HTML 5 file control seems to place a lock on the last loaded file which
					// was interfering with the saving and overwriting of that same file.
					// So I will reset it by destroying and recreating, allowing the GC to release
					// any old file locks.
					var control = $("#sb_file");
					control.replaceWith( control = control.clone( true ) );
                
					// if editors dont reflect current source when we change back to a source visible window mode 
					// then we may need to setTimeout on the following two lines to give editors a chance to update display 
					API_SetWindowMode(3);
					
					sb_run();
				},
				error: function (xhr, ajaxOptions, thrownError) {
					API_LogMessage("If you are hosting this on your own server, make sure to add mime type for .prg files as text/json");
					API_LogMessage(xhr.status + " : " + xhr.statusText);
					alertify.log(xhr.status + " : " + xhr.statusText);
					alertify.log("See user log for more info");
				}
			});
		}, 250);
	}
	
	function sb_browse_samples() {
	
		if (typeof(EVT_CleanSandbox) == typeof(Function)) {
			try {
				EVT_CleanSandbox();
				EVT_CleanSandbox = null;
			}
			catch (err) {
			}
		}

		// Let Local Filesystem version use samples browser as an 'online' only feature for convenience.  
		// If running local filesystem ask them if they want to AJAX to online web samples, 
		// otherwise attempt to ajax to local filesystem which works on firefox (and possibly others?)
		if (!VAR_TRIDENT_HOSTED) {
			alertify.confirm("Go online to access samples?", function (e) {
					if (e) {
						VAR_ForceOnlineSamples = true;
						sb_browse_samples_action();
					} else {
						VAR_ForceOnlineSamples = false;
						API_LogMessage("Since you chose not to go online you may encounter permissions errors attempting to load samples using this browser.  You can always use the file pickers to manually load each sample individually offline from your samples folder.");
						sb_browse_samples_action();
					}
			});
		}
		else {
			VAR_ForceOnlineSamples = false;
			sb_browse_samples_action();
		}
	}
	
	function sb_refresh_slots(callback) {
		// clear out slots select
		$("#sb_sel_trident_slot").html("<option></option>");
		
		VAR_TRIDENT_API.GetAppKeys("SandboxSaveSlots", function(result) {
			if (result != null) {
				for(var idx=0; idx < result.length; idx++) {
					$("#sb_sel_trident_slot").append($("<option></option>").attr("value", result[idx].id).text(result[idx].key));
				}
				
				var my_options = $("#sb_sel_trident_slot option");
				my_options.sort(function(a,b) {
					if (a.text > b.text) return 1;
					else if (a.text < b.text) return -1;
					else return 0
				})
				$("#sb_sel_trident_slot").empty().append( my_options );
				
				// in case editor toolbar wrapped or flattened due to wider/thinner save slot select
				sb_fit_editors(); 

				if (typeof(callback) == "function") callback();
			}
			else {
				alertify.error("check database configuration");
			}
		});
	}
	
	function sb_run_autorun() {
        VAR_TRIDENT_API.GetAppKey("SandboxScriptUnits", "autorun", function (result) {
			if (result == null || result.id == 0) return;
			
			API_AppendUnitScript(result.val);
		});
	}
	
	function sb_load_slot_action(autorun) {
		var selText = $("#sb_sel_trident_slot").find(":selected").text();
		
		if (selText == "") return;
		
        VAR_TRIDENT_API.GetAppKey("SandboxSaveSlots", selText, function (result) {
			var sandboxObject = JSON.parse(result.val);
		
			sb_markup_hash = CryptoJS.SHA1(sandboxObject.htmlText).toString();
			sb_script_hash = CryptoJS.SHA1(sandboxObject.scriptText).toString();
		
			$("#sb_txt_ProgramName").val(sandboxObject.progName);

			editorMarkup.setValue(sandboxObject.htmlText);
			editorScript.setValue(sandboxObject.scriptText);

			if (typeof(autorun) != "undefined" && autorun) sb_run();
				
		});
	}
	
	function sb_load_slot(autoRun) { 
		var htmlHash = CryptoJS.SHA1(editorMarkup.getValue()).toString();
		var scriptHash = CryptoJS.SHA1(editorScript.getValue()).toString();
		
		if (htmlHash != sb_markup_hash || scriptHash != sb_script_hash) {
			alertify.confirm("You have pending changes, are you sure?", function (e) {
				// user clicked "ok"
				if (e) { sb_load_slot_action(autoRun); }
				else {
					// The chose to abort load of selected slot, attempt to re-select the program
					// by the name they have entered in the Program Name slot if it exists
					$("#sb_sel_trident_slot").val($("#sb_txt_ProgramName").val());
				}
			});
			
			return ;
		}
		
		sb_load_slot_action(autoRun);
	}
	
	// If local storage is available (Hosted or AppCache)
	// then this will let you load a program from a save slot
	function sb_save_slot(callback) { 
		var selText = $("#sb_sel_trident_slot").find(":selected").text();

		var progNameString = $("#sb_txt_ProgramName").val();
		var htmlTextString = editorMarkup.getValue();
		var scriptTextString = editorScript.getValue();

		sb_markup_hash = CryptoJS.SHA1(htmlTextString).toString();
		sb_script_hash = CryptoJS.SHA1(scriptTextString).toString();
		
		var sandboxObject = { progName: progNameString, htmlText: htmlTextString, scriptText: scriptTextString };
		
		var json_text = JSON.stringify(sandboxObject, null, 2);
		
		if (selText != progNameString) {
			alertify.confirm("Are you sure you want to save into slot " + progNameString, function (e) {
				if (e) {
					try {
						//API_SetIndexedAppKey("SandboxSaveSlots", progNameString, json_text);
						VAR_TRIDENT_API.SetAppKey("SandboxSaveSlots", progNameString, json_text, function(result) {
							if (result.success) {
								sb_refresh_slots(function() {
									// todo: make VAR_TRIDENT_API SetAppKey (both trident and service) return id so i could select by that
									$("#sb_sel_trident_slot option").filter(function() {
										return $(this).text() == progNameString; 
									}).prop('selected', true);
								});
								
								if (typeof(callback) == "function") callback();
							}
							else {
								alertify.error("error calling SetKey()");
							}
						});
					}
					catch(e) {
						alertify.error("Error encountered during save to TridentDB : " + e.message);
					}
				} 
			});
		}
		else {
			VAR_TRIDENT_API.SetAppKey("SandboxSaveSlots", progNameString, json_text, function(result) {
				if (result.success) {
					alertify.success("saved");
					if (typeof(callback) == "function") callback();
				}
				else {
					alertify.error("Error encountered during save");
				}
			});
		}
	}
	
	function sb_del_slot() {
		var selText = $("#sb_sel_trident_slot").find(":selected").text();
		
		if (selText == "") return;
		
		alertify.confirm("Are you sure you want to delete Trident Program Slot : " + selText, function (e) {
				if (e) {
				
					VAR_TRIDENT_API.GetAppKey("SandboxSaveSlots", selText, function (result) {
							
						VAR_TRIDENT_API.DeleteAppKey(result.id, function(result) {
							if (result) {
								sb_refresh_slots();
							}
							else {
								alertify.log("Error encountered during delete");
							}
						});
					});
				}
				else {
					alertify.error("No save at that slot");
				}
		});
	}
	
	// If local storage is available (Hosted or AppCache)
	// then this will let you save a program to a save slot
	function sb_compile_template() 	{
		var file = document.getElementById('sb_file_template').files[0];
		if(file) {
			var reader = new FileReader();

			reader.readAsText(file, "UTF-8");

			// Handle progress, success, and errors
			//reader.onprogress = updateProgress;
			reader.onload = sb_template_loaded;
			reader.onerror = errorHandler;
		}
	}
	
// END SANDBOX I/O ROUTINES
	
	// Make clicking on the Header Caption toggle its font between Heorot (Greek looking) and normal
	function sb_toggle_header_font() {
		var fontName = $('#sb_header_caption').css("font-family");
		
		if (fontName.indexOf('Heorot') != -1) {
			$('#sb_header_caption').css("font-family", "Sans");
			$('#sb_header_caption2').css("font-family", "Sans");
			if (localStorage) localStorage["header-font"] = "Sans";
		}
		else {
			$('#sb_header_caption').css("font-family", "Heorot");
			$('#sb_header_caption2').css("font-family", "Heorot");
			if (localStorage) localStorage["header-font"] = "Heorot";
		}
	}
	
	function sb_new_program() {
		var htmlHash = CryptoJS.SHA1(editorMarkup.getValue()).toString();
		var scriptHash = CryptoJS.SHA1(editorScript.getValue()).toString();
		
		if (VAR_UI_Settings.pend_changes_warn) {
			if (htmlHash != sb_markup_hash || scriptHash != sb_script_hash) {
				alertify.confirm("You have pending changes, are you sure?", function (e) {
					// user clicked "ok"
					if (e) { 
						if (VAR_WindowMode == 3) API_SetWindowMode(2);
						sb_clean_sandbox();
						return;
					}
				});
				return ;
			}
			else {
				if (VAR_WindowMode == 3) API_SetWindowMode(2);
				sb_clean_sandbox();
				return;
			}
		}
		
		if (VAR_WindowMode == 3) API_SetWindowMode(2);
		sb_clean_sandbox();
	}
	
	function API_SetDarkTheme() {
		API_SetBackgroundColor("#444");
		$("#UI_MainPlaceholder").css("color", "#fff");
	}
	
	function API_SetLightTheme() {
		API_SetBackgroundColor("#fff");
		$("#UI_MainPlaceholder").css("color", "#000");
	}
	
	// Clear Environment  
	// Ideally this would clear out the sandbox entirely
	function sb_clean_sandbox()	{
		// clear any old passwords and password handlers
		$("#sb_password_text").val("");
		$("#sb_password_ok").unbind("click");
		
		// clear source code
		var markupText = "<h3>My Sandbox WinJS Program</h3>\r\n";
		var scriptText = "// Recommended practice is to place variables in this object and then delete in cleanup\r\nvar sbv = {\r\n\tmyVar : null,\r\n\tmyVar2 : 2\r\n}\r\n\r\nfunction EVT_CleanSandbox()\r\n{\r\n\tdelete sbv.myVar;\r\n\tdelete sbv.myVar2;\r\n}\r\n";

		editorMarkup.setValue(markupText);
		editorScript.setValue(scriptText);
	
		sb_markup_hash = CryptoJS.SHA1(editorMarkup.getValue()).toString();
		sb_script_hash = CryptoJS.SHA1(editorScript.getValue()).toString();
		
		$("#sb_txt_ProgramName").val('New Program');

		// clear out the MainOutput and Log divs and let client do any cleanup if they registered callback
		API_ClearOutput();
	}
	
	function toggleVisibility(id) {
       var e = document.getElementById(id);
       if(e.style.display == 'block')
          e.style.display = 'none';
       else
          e.style.display = 'block';
	}
	
	var hookScripts = function(url, src) {
		var s = document.createElement("script");
		s.type = "text/javascript";
		//s.id = 'scriptDynamic';
		s.src = url || null;
		s.innerHTML = src || null;
		document.getElementsByTagName("head")[0].appendChild(s);
	};
	
	// Trying to code a more elegant solution to this 'run' process
	// Older method hacked together a string with script first
	// and added entire string at once, since parsed at same time all ran fine.
	// This implementation works with DOM to add the script element after 
	// appending the html
	function sb_run() {
		API_ClearOutput();
		
		var markupString = editorMarkup.getValue();
		var scriptString = editorScript.getValue();

		// Kind of a hack, will need to make sure its optimized once program sizes (script) grows.
		// In order to give the user the option to start their app up in fullscreen mode I am having to implement
		// this hack.  The msRequestFullscreen is very particular about only working when called from a 'user-initiated' action
		// like a button press.  This (sb_run) method is called from a button click but the 'user-initiated' seems to get lost
		// if it runs in a setTimeout or when executing your code (which i will add later in this method).  So the hack is to 'peek' into
		// the script and if a text string match exists : FLAG_StartPrgFullscreen (even if it is in a comment), i will automatically
		// fullscreen the UI_MainPlaceholder div.  Esc key will exist or you should provide your own means of 'unfullscreen'-ing it.
		if (scriptString.substring(0, 250).indexOf("FLAG_StartPrgFullscreen") != -1) document.getElementById("UI_MainPlaceholder").msRequestFullscreen();
		
		// The timeouts are probably not necessary but lets give dom 
		// time between our clearing (above), loading html, and loading scripts
		// delay also allows API_ClearOutput to wait for user EVT_CleanSandbox to run
		setTimeout(function() {
			// HTML needs to go first so script will work if they have code outside functions
			$("#UI_MainPlaceholder").append(markupString);

			var s = document.createElement("script");
			s.innerHTML = scriptString;
		
			// give dom a chance to clean out by waiting a bit?
			setTimeout(function() {
				document.getElementById("UI_MainPlaceholder").appendChild(s);
			}, 150);
		}, 250);
	}
	
	function sb_launch() {
		var progName = $("#sb_txt_ProgramName").val();
		if (progName == "") {
			alertify.log("Load a program or give this one a program name"); 
			return;
		}
		
		var htmlHash = CryptoJS.SHA1(editorMarkup.getValue()).toString();
		var scriptHash = CryptoJS.SHA1(editorScript.getValue()).toString();

		var selSlot = $("#sb_sel_trident_slot").find(":selected").text();
		
		// if no pending changes have been made to the editors then skip save
		if (progName == selSlot && htmlHash == sb_markup_hash && scriptHash == sb_script_hash) {
			// ideally we would target progName instead of _blank to reuse existing window
			// but due to hash params they dont refresh correctly and need full reload
			// if you need to side by side dev you will just save in ide and manually refresh sandbox loader page
			window.open('SandboxLoaderWJS.htm#RunSlot=' + $("#sb_txt_ProgramName").val(), '_blank');
			return;
		}
		
		sb_save_slot(function() {
			window.open('SandboxLoaderWJS.htm#RunSlot=' + $("#sb_txt_ProgramName").val(), '_blank');
		});
	}
	
	function sb_toggle_markup()	{
		editorMode = EditorModeEnum.Markup;

		sb_fit_editors();
	}
	
	function sb_toggle_script()	{
		editorMode = EditorModeEnum.Script;
		
		sb_fit_editors();
	}
	
	function sb_toggle_split() {
		if (editorMode == EditorModeEnum.Split) {
			sb_split_mode = (sb_split_mode == 0)?1:0;
		}
		
		editorMode = EditorModeEnum.Split;
		
		sb_fit_editors();
	}
	
	function sb_fit_log() {
		var used = 80;
		var isCaptionVisible = $("#sb_div_caption").is(":visible");
		var isLoaderVisible = $("#sb_div_mainloader").is(":visible");
		var isDevbarVisible = true;
		
		var isfullscreen = (!window.screenTop && !window.screenY);
		
		// fix for metro ie fullscreen or f11 desktop ie fullscreen; if the fullscreen element is not null
		// then we are in dev fullscreen and caption and loader should not be
		// calculated even if they are visible (yet outside fullscreen element)
		if (isfullscreen) {
			var element = document.fullscreenElement || document.msFullscreenElement || document.mozFullScreenElement;
			if (element) {
				isCaptionVisible = false;
				isLoaderVisible = false;
				if (element.id == "divCode") isDevbarVisible = false;
			}
		}
		
		// subtract height of tab strip itself (low width might wrap tabs)
		used += $("#UI_TabsOutput").find(".ui-tabs-nav").height();
		
		if (isCaptionVisible||isLoaderVisible||isDevbarVisible) {
			if (isCaptionVisible) used += ($("#sb_div_caption").height());
			if (isLoaderVisible) used += ($("#sb_div_mainloader").height() + 4);
		}
		
		used += $("#UI_TxtLogConsole").height() + 4 + 14; // 14 compensate for padding?
		
		$("#UI_TxtLogText").height($(window).height() - used);
	}
	
	function sb_fit_editors() {
		if ($(window).width() < 1100) {
			$(".divWideButtons").hide(); 
			$(".divTinyButtons").show(); 
		}
		else {
			$(".divWideButtons").show(); 
			$(".divTinyButtons").hide(); 
		}
		
		var used = $("#ui_editor_toolbar").height() + 12;
		var isCaptionVisible = $("#sb_div_caption").is(":visible");
		var isLoaderVisible = $("#sb_div_mainloader").is(":visible");
		var isDevbarVisible = true;
		
		var isfullscreen = (!window.screenTop && !window.screenY);
		
		// fix for metro ie fullscreen or f11 desktop ie fullscreen; if the fullscreen element is not null
		// then we are in dev fullscreen and caption and loader should not be
		// calculated even if they are visible (yet outside fullscreen element)
		if (isfullscreen) {
			var element = document.fullscreenElement || document.msFullscreenElement || document.mozFullScreenElement;
			if (element) {
				isCaptionVisible = false;
				isLoaderVisible = false;
				if (element.id == "divCode") isDevbarVisible = false;
			}
		}
		
		if (isCaptionVisible||isLoaderVisible||isDevbarVisible) {
			if (isCaptionVisible) used += ($("#sb_div_caption").height());
			if (isLoaderVisible) used += ($("#sb_div_mainloader").height() + 4);
		}
		
		switch (editorMode) {
			case EditorModeEnum.Markup :
				$("#ui_div_markup").css("width", "100%");
				$("#ui_div_script").css("width", "100%");
				
				// this is how we go about hiding and resizing editors
				editorMarkup.getWrapperElement().style.display = "block";
				editorScript.getWrapperElement().style.display = "none";
				editorMarkup.setSize("100%", $(window).height() - used);

				// we have hid the script editor so disable its buttons
				$("#sb_btn_markup_fs").prop('disabled', '');
				$("#sb_btn_script_fs").prop('disabled', 'disabled');
				break;
			case EditorModeEnum.Split : 
				// this is how we go about hiding and resizing editors
				editorMarkup.getWrapperElement().style.display = "block";
				editorScript.getWrapperElement().style.display = "block";

				var editorSize = ($(window).height() - used)/2;

				if (sb_split_mode == 0) {
					$("#ui_div_markup").css("width", "100%");
					$("#ui_div_script").css("width", "100%");
					editorMarkup.setSize("100%", editorSize);
					editorScript.setSize("100%", editorSize);
				}
				else {
					$("#ui_div_markup").css("width", "50%");
					$("#ui_div_script").css("width", "50%");
					editorMarkup.setSize("100%", $(window).height() - used);
					editorScript.setSize("100%", $(window).height() - used);
				}
		
			
				$("#sb_btn_markup_fs").prop('disabled', '');
				$("#sb_btn_script_fs").prop('disabled', '');
				break;
			case EditorModeEnum.Script : 
				$("#ui_div_markup").css("width", "100%");
				$("#ui_div_script").css("width", "100%");
				
				// this is how we go about hiding and resizing editors
				editorMarkup.getWrapperElement().style.display = "none";
				editorScript.getWrapperElement().style.display = "block";
				editorScript.setSize("100%", $(window).height() - used);

				$("#sb_btn_markup_fs").prop('disabled', 'disabled');
				$("#sb_btn_script_fs").prop('disabled', '');
				break;
		}
	}
	
	function sb_console_eval() {
		sb_lastconsolecmd = $("#UI_TxtLogConsole").val();
		API_LogMessage("=> " + sb_lastconsolecmd);

		// For some reason API_Inspect calls were not invoking the jquery dialog
		// Not really sure why but adding small delay allows this to work
		setTimeout(function() {
			try {
				var res = eval(sb_lastconsolecmd);
			
				if (res != null) API_LogMessage("result: " + res);
			}
			catch (err) {
				API_LogMessage("Error : " + err.message);
			}
		}, 100);

		$("#UI_TxtLogConsole").val("");
	}
	
	function fsMarkup()	{
		editorMarkup.setOption("fullScreen", !editorMarkup.getOption("fullScreen"));
	}
	
	function fsScript()	{
		editorScript.setOption("fullScreen", !editorScript.getOption("fullScreen"));
	}
	
	function sb_fs_code() {
		var inFullScreenMode = document.fullscreenElement || 
		document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement;

		if (inFullScreenMode) {
			if (document.exitFullscreen) { document.exitFullscreen(); } 
			else if (document.msExitFullscreen) { document.msExitFullscreen(); } 
			else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } 
			else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
		} 
		else {
			var docElm = tblCode;
			if (docElm.requestFullscreen) {
				docElm.requestFullscreen();
			} else if (docElm.msRequestFullscreen) {
				docElm.msRequestFullscreen();
			} else if (docElm.mozRequestFullScreen) {
				docElm.mozRequestFullScreen();
			} else if (docElm.webkitRequestFullscreen)
				docElm.webkitRequestFullscreen();
			}    
	}
	
	// function to inspect a variable/expression highlighted in a script or markup editor
	function sb_inspect() {
		var strSelection;
		var scriptSelection = editorScript.getSelection();
		var markupSelection = editorMarkup.getSelection();
		
		if (scriptSelection != "" && markupSelection != "") alertify.error("Ambiguous selection; Highlighted code exists in both editors; using Script selection", "", 0);
		
		if (scriptSelection == "" && markupSelection == "") {
				alertify.alert("This feature requires you to select a variable or object in the script editor before clicking 'Inspect'.");
				return;
		}
		
		if (scriptSelection != "") strSelection = scriptSelection;
		else strSelection = markupSelection;
		
		var objResult;
		try {
			objResult = eval(strSelection);
		}
		catch (exc) {
			alertify.error("malformed inspection selection");
			return;
		}

		var tbl = prettyPrint( objResult, { /* options such as maxDepth, etc. */ });
		$(tbl).dialog({ title: 'Trident Object/Variable Inspector', width: 'auto', maxHeight: ($(window).height() - 50) });
	}
	
//
// TRIDENTSANDBOX APP/KEY/VALUE OBJECT STORE INTERFACE API - IMPLEMENTED USING INDEXEDDB
// This is an attempt to provide as simple (as possible?) interface for using indexedDb to increase storage capabilities when running Hosted or AppCached
// If you run out of the ~5MB of local storage, you can expand into this relatively easily.
// I intend to use this for storing AppSave slots for your programs as well as for In-Memory databases using Loki.js and serialized as json for the value.
// You may use it for whatever string 'value' you want to save (serialized objects/text/settings) but the app is for your convenience/organization, every app can in theory read 
// any other app's key/values.
//
	
// Get a Trident App/Key/Val object by app/key
function API_GetIndexedAppKey(app, key, callback) {
	var transaction = VAR_TRIDENT_DB.transaction(["TridentSandboxKVP"],"readonly");
	var store = transaction.objectStore("TridentSandboxKVP");
	var index = store.index("appkey");
  	var appkey = app + "," + key;
  	var request = index.get(appkey);

  	request.onsuccess = callback;
}

// Get a Trident App/Key/Val object by id (if for some reason you keep a collection of id's, you can get the object back with this)
// Added extra optional data param you can pass and process within your aync callback
function API_GetIndexedAppKeyById(id, callback, data) {
	var transaction = VAR_TRIDENT_DB.transaction(["TridentSandboxKVP"],"readonly");
	var store = transaction.objectStore("TridentSandboxKVP");
  	var request = store.get(id);

	if (typeof(callback) != "function") API_LogMessage("Call to API_GetIndexedAppKeyById with invalid callback param");
	
	request.onsuccess = (function(data){
		return function(e) { callback(e, data) };
	})(data);   

}

// Will add or update (if that app/key combo already exists) a Trident App/Key/Value object
function API_SetIndexedAppKey(app, key, val) {
	var transaction = VAR_TRIDENT_DB.transaction(["TridentSandboxKVP"],"readwrite");
    var store = transaction.objectStore("TridentSandboxKVP");
	var index = store.index("appkey");
  	var appkey = app + "," + key;
  	var request = index.get(appkey);

	// first try to retrieve an existing object by that key
	// need to do this because to update an object you need to have id in object, otherwise it will append id with new autocounter and clash the unique index appkey
	request.onsuccess = function(e) {
		var res = e.target.result;
		
		if (res == null) {
			res = {
				app:app,
				key:key,
				appkey: app + ',' + key,
				val:val
			}
		}
		else {
			res.val = val;
		}
		
		var requestPut = store.put(res);
 
		requestPut.onerror = function(e) {
			alertify.error("set error: " + e.target.error.name);
		}
 
		requestPut.onsuccess = function(e) {
			alertify.success("saved");
		}
	};
	
	request.onerror = function(e) {
		alertify.error("get error: " + e.target.error.name);
	}
}
	
// The object can only be deleted by the primary key 'id' which is autoincremented number on object
function API_DelIndexedAppKey(id) {
	var transaction = VAR_TRIDENT_DB.transaction(["TridentSandboxKVP"],"readwrite");
	var store = transaction.objectStore("TridentSandboxKVP");
	
	var request = store.delete(id);
	request.onsuccess = function(evt) {
		alertify.success("deleted");
	};
	request.onerror = function(evt) {
		alertify.error("failed to delete id: " + id);
	}
}

// Retrieve a cursor for all App/Key/Val objects by app
// Your callback is called once per record and you must advance cursor (see examples)
function API_GetIndexedAppCursor(app, callback) {
	var transaction = VAR_TRIDENT_DB.transaction(["TridentSandboxKVP"], "readonly");
	var store = transaction.objectStore("TridentSandboxKVP");
	var index = store.index("app");
 
	// We want cursor to all values matching our (single) app param
	var singleKeyRange = IDBKeyRange.only(app);

	// Match anything past "Bill", including "Bill"
	//var lowerBoundKeyRange = IDBKeyRange.lowerBound("Bill");

	// Match anything past "Bill", but don't include "Bill"
	//var lowerBoundOpenKeyRange = IDBKeyRange.lowerBound("Bill", true);

	// Match anything up to, but not including, "Donna"
	//var upperBoundOpenKeyRange = IDBKeyRange.upperBound("Donna", true);

	// Match anything between "Bill" and "Donna", but not including "Donna"
	//var boundKeyRange = IDBKeyRange.bound("Bill", "Donna", false, true);

	// To use one of the key ranges, pass it in as the first argument of openCursor()/openKeyCursor()
	var cursor = index.openCursor(singleKeyRange);
 
	cursor.onsuccess = callback;
}

// This can allow end user running in hosted or appcached environment to use the TridentDB save slots as 'modules'
// They can switch between programs using this API Call to stop the existing program and switch to (and run) a different save slot program
// Since hosted, you can pass params between the two programs using local storage or TridentDB/indexed db.
//function API_TransferSlot(slotId) {
//	API_GetIndexedAppKey("SandboxSaveSlots", "ProgramSlot" + slotId, function(e) {
//		var res = e.target.result;
//		
//		if (res == null) {
//			alertify.error("No save at that slot");
//			return;
//		}
		
//		var sandboxObject = JSON.parse(res.val);
	
//		sb_markup_hash = CryptoJS.SHA1(sandboxObject.htmlText).toString();
//		sb_script_hash = CryptoJS.SHA1(sandboxObject.scriptText).toString();
	
//		$("#sb_txt_ProgramName").val(sandboxObject.progName);

//		editorMarkup.setValue(sandboxObject.htmlText);
//		editorScript.setValue(sandboxObject.scriptText);
	
//		sb_run();
//	});
//}

function API_Backup_TridentDB(filename) {
	var transaction = VAR_TRIDENT_DB.transaction(["TridentSandboxKVP"], "readonly");
	var store = transaction.objectStore("TridentSandboxKVP");

	var cursor = store.openCursor();
 
	var keyArray = [];
 
	cursor.onsuccess = function(e) {
	  	var cursor = e.target.result;
      
		if(cursor) {
          	var currObject = cursor.value;
          
			keyArray.push(currObject);
          
            cursor.continue();
		}
		else {
			if (keyArray.length == 0) {
				alertify.log("Nothing to backup, TridentDB is empty");
				return;
			}
			
			if (filename == null) filename = "TridentDB.backup";
			
			API_SaveTextFile(filename, JSON.stringify(keyArray));
		}
	};

}

function API_Restore_TridentDB() {
	$("#sb_div_restorefile").show();
}

// END TRIDENT DB

// LIBRARY UNIT I/O
// This collection of functions support the ability for you to modularize your code into 
// Markup and/or Script fragments called 'Units'.  With this functionality you can move fragments of html or
// javascript into a unit to be called up from other programs.  So you might fine tune your units
// in the editors and run them to test them, and then use console commands to save them with a name to be 
// recalled programmatically within a real prg.
// Initial Implementation will be invoking these functions via the Text Console calling these commands : 
	function API_LogMarkupUnits() {
		
		VAR_TRIDENT_API.GetAppKeys("SandboxMarkupUnits", function(result) {
			for (var idx = 0; idx < result.length; idx++) {
				API_LogMessage(result[idx].key);
			}
		});
	}
	
	function API_SaveMarkupUnit(unitName) {
		var htmlTextString = editorMarkup.getValue();
		
		VAR_TRIDENT_API.SetAppKey("SandboxMarkupUnits", unitName, htmlTextString, function(result) {
			if (result.success) return true;
			
			alertify.error("Error calling SetAppKey()");
			return false;
        });
	}
	
	function API_LoadMarkupUnit(unitName) {
	
        VAR_TRIDENT_API.GetAppKey("SandboxMarkupUnits", unitName, function (result) {
			if (result == null || result.id == 0) {
				alertify.error("No markup unit by that name");
				return false;
			}
			
			sb_markup_hash = CryptoJS.SHA1(result.val).toString();
			editorMarkup.setValue(result.val);
		});
	}
	
	function API_GetMarkupUnit(unitName, callback) {
        VAR_TRIDENT_API.GetAppKey("SandboxMarkupUnits", unitName, function (result) {
			if (result == null || result.id == 0) {
				alertify.error("No markup unit by that name");
				return false;
			}
			
			callback(result.val);
		});
	}
	
	// Import
	function API_ImportMarkupUnit(unitName, clearFirst) {
		if (clearFirst) API_ClearHtmlLog();
		
		API_GetMarkupUnit("first", function(unitString) {
			API_LogHtml(unitString);
		});
	}
	
	function API_LogScriptUnits() {
		
		VAR_TRIDENT_API.GetAppKeys("SandboxScriptUnits", function(result) {
			for (var idx = 0; idx < result.length; idx++) {
				API_LogMessage(result[idx].key);
			}
		});
	}
	
	function API_SaveScriptUnit(unitName) {
		var scriptTextString = editorScript.getValue();
		
		VAR_TRIDENT_API.SetAppKey("SandboxScriptUnits", unitName, scriptTextString, function(result) {
			if (result.success) return true;
			
			alertify.error("Error calling SetAppKey()");
			return false;
        });
	}
	
	function API_LoadScriptUnit(unitName) {
	
        VAR_TRIDENT_API.GetAppKey("SandboxScriptUnits", unitName, function (result) {
			if (result == null || result.id == 0) {
				alertify.error("No script unit by that name");
				return false;
			}
			
			sb_script_hash = CryptoJS.SHA1(result.val).toString();
			editorScript.setValue(result.val);
		});
	}
	
	function API_ImportScriptUnit(unitName, callback) {
	
        VAR_TRIDENT_API.GetAppKey("SandboxScriptUnits", unitName, function (result) {
			if (result == null || result.id == 0) {
				alertify.error("No script unit by that name");
				return false;
			}
			
			API_AppendUnitScript(result.val, callback);
		});
	}
	
	function API_AppendUnitScript(scriptText, callback) {
		var s = document.createElement("script");
		s.innerHTML = scriptText;
		
		document.getElementById("UI_LibUnitPlaceholder").appendChild(s);
		
		if (typeof(callback) == "function") {
			setTimeout(function() {
				callback();
			}, 200);
		}
	}
	
	function API_ClearUnitScripts() {
		$("#UI_LibUnitPlaceholder").empty();
	}
	
	// API/HELPER ROUTINES 
	// Helper method to support hosted or appcache url params
	function API_GetURLParameter(sParam) {
		var sPageURL = window.location.hash.substring(1);

		var sURLVariables = sPageURL.split('&');
		for (var i = 0; i < sURLVariables.length; i++)
		{
			var sParameterName = sURLVariables[i].split('=');
			if (sParameterName[0] == sParam)
			{
				return decodeURIComponent(sParameterName[1]);
			}
		}
	}
	
	function API_ClearOutput() {

		// Null out old event handlers
		EVT_WindowResize = null;
		EVT_TridentChanged = null;
		EVT_UserLoadCallback = null;
		EVT_UserDataLoadCallback = null;
		
		// allow user to do any cleanup they might want to do
		if (typeof(EVT_CleanSandbox) == typeof(Function)) {
			try {
				EVT_CleanSandbox();
				EVT_CleanSandbox = null;
			}
			catch (err) {
				alertify.error("EVT_CleanSandbox: " + err);
			}
		}
		
		document.title = "Trident Sandbox WJS v" + VAR_TRIDENT_VERSION;
	
		// clear any old passwords and password handlers
		$("#sb_password_text").val("");
		$("#sb_password_ok").unbind("click");
		$("#sb_div_restorefile").hide();
		
		API_SetBackgroundColor("#444");
		$("#UI_MainPlaceholder").css("color", "white");
		
		API_HideUserLoader();
		API_ClearLog();
		API_ClearHtmlLog();
		
		// No longer clearing unit scripts, they are likely already attached to window 
		// and i am establishing an autorun script which could affect ui or load other scripts to be used
		// for the duration of the page load.
		
		//API_ClearUnitScripts();	

		// main includes div with script so hopefully EVT_CleanSandbox has completed
		setTimeout(function() {
			API_ClearMain();
		}, 100);
		
		API_SetActiveTab(0);
	}
	
	function API_LogMain(msg) {
		$("#UI_MainPlaceholder").append(msg + "<br/>");
	}
	
	function API_ClearMain() {
		$("#UI_MainPlaceholder").empty();
	}
	
	function API_LogHtml(msg) {
		$("#UI_HtmlLogPlaceholder").append(msg + "<br/>");
		
		// Using flag variable to prevent multiple consecutive logmessage calls from overloading the flash effect
		// Will only flash once every 4 seconds
		if (!sb_flashtabhtml) {
			sb_flashtabhtml = true;

			// not sure if there is a more elegant jquery selector but this will flash the text log tab header to indicate activity on that tab
			$($($("#UI_TabsOutput").find("ul")[0]).find("li")[1]).find("a").effect("pulsate", {}, 1000);
			
			setTimeout(function() { sb_flashtabhtml = false; }, 4000);
		}
	}
	
	function API_ClearHtmlLog() {
		$("#UI_HtmlLogPlaceholder").empty();
	}
	
	function API_LogMessage(msg) {
		$("#UI_TxtLogText").val($("#UI_TxtLogText").val() + msg + "\r\n");
		
		// Using flag variable to prevent multiple consecutive logmessage calls from overloading the flash effect
		// Will only flash once every 4 seconds
		if (!sb_flashtabtext) {
			sb_flashtabtext = true;

			// not sure if there is a more elegant jquery selector but this will flash the text log tab header to indicate activity on that tab
			$($($("#UI_TabsOutput").find("ul")[0]).find("li")[2]).find("a").effect("pulsate", {}, 1000);
			
			setTimeout(function() { sb_flashtabtext = false; }, 4000);
		}
	}
	
	function API_LogObject(objToLog, objName) {
		if (objName != null && (typeof(objName) == "string"))
			API_LogMessage(objName + " = ");
		
		API_LogMessage(JSON.stringify(objToLog, null, '\t'));
	}
	
	function API_ClearLog()	{
		$("#UI_TxtLogText").val("");
	}
	
	function API_SetActiveTab(tabId) {
		$("#UI_TabsOutput" ).tabs( "option", "active", tabId );	
	}
	
	// Make Developer area fullscreen (Editors, output, and run bar)
	function API_MetalFullscreen() {
		var elem = sb_div_metalFullscreen;
		if (elem.requestFullscreen) {
			elem.requestFullscreen();			
		} else if (elem.msRequestFullscreen) {
			elem.msRequestFullscreen();
		} else if (elem.mozRequestFullScreen) {
			elem.mozRequestFullScreen();
		} 
	}
	
	function API_UserFullscreen(elem) {
		//if (elem == null) elem = UI_TabsOutput;
		if (elem == null) elem = document.getElementById("UI_MainPlaceholder");
		
		if (elem.requestFullscreen) {
			elem.requestFullscreen();
		} else if (elem.msRequestFullscreen) {
			elem.msRequestFullscreen();
		} else if (elem.mozRequestFullScreen) {
			elem.mozRequestFullScreen();
		} else if (elem.webkitRequestFullscreen) {
			elem.webkitRequestFullscreen();
		}    
	}
	
	function API_UserFullscreenExit() {
		if (document.exitFullscreen) { document.exitFullscreen(); } 
		else if (document.msExitFullscreen) { document.msExitFullscreen(); } 
		else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } 
		else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
	}
	
	function API_UserFullToggle() {
		var inFullScreenMode = document.fullscreenElement || 
		document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement;

		if (inFullScreenMode) {
			if (document.exitFullscreen) { document.exitFullscreen(); } 
			else if (document.msExitFullscreen) { document.msExitFullscreen(); } 
			else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } 
			else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
		} 
		else {
			var docElm = document.documentElement;
			if (docElm.requestFullscreen) {
				docElm.requestFullscreen();
			} else if (docElm.msRequestFullscreen) {
				docElm.msRequestFullscreen();
			} else if (docElm.mozRequestFullScreen) {
				docElm.mozRequestFullScreen();
			} 
		}    
	}
	
	function API_PlaySound(soundFilename) {
		var aud = new Audio();
		aud.src = 'sounds/' + soundFilename;
		aud.load();
		aud.play();
	}
	
	function API_PlaySoundURI(soundURI) {
		var aud = new Audio();
		aud.src = soundURI;
		aud.load();
		aud.play();
	}
	
	// Display the User Area file loader
	function API_ShowLoad() {
		$("#sb_div_userfile").show();
	}
	
	function API_ShowDataLoad() {
		$("#sb_div_userdatafile").show();
	}
	
	function API_HideUserLoader() {
		$('#sb_div_userfile').hide();   // hide user file picker if visible
	}
	
	function API_HideUserDataLoader() {
		$("#sb_div_userdatafile").hide();
	}
	
	// Handling Blobs is somewhat browser specific 
	// As such this seems to work on IE 11 and firefox
	function API_DataUrlToBlob(dataURL) {
		// convert base64 to raw binary data held in a string
		var byteString = atob(dataURL.split(',')[1]);
 
		// separate out the mime component
		var mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
 
		// write the bytes of the string to an ArrayBuffer
		var arrayBuffer = new ArrayBuffer(byteString.length);
		//var _ia = new Uint8Array(arrayBuffer);
		var _ia = new Int8Array(arrayBuffer);
		for (var i = 0; i < byteString.length; i++) {
			_ia[i] = byteString.charCodeAt(i) & 0xff;
		}

		//var dataView = new DataView(arrayBuffer);
		//var blobResult = new Blob([dataView], { type: mimeString });
		var blobResult = new Blob([_ia], { type: mimeString });
		return blobResult;
	}

	// Pass in a filename and some text to save and this will 'serve' up that text as a download
	function API_SaveTextFile(fileName, saveString)	{
		// The File Loaders seem to place a lock on the file so, in the event they are saving to the same filename,
		// lets clear out the old file control so that (if they save to the same filename as they last loaded) it will work.
		var control = $("#sb_user_file");
		control.replaceWith( control = control.clone( true ) );
		
		if (typeof Blob == "undefined") {
			alert('no blobs available (incompatible browser?)');
		}
		else {
			// if not using internet explorer then fallback to filesaver.js polyfill method
			if (window.navigator.msSaveBlob === undefined) {
				var blob = new Blob([saveString], {type: "application/octet-stream"});
				saveAs(blob, fileName);
			}
			else {
				var blob1 = new Blob([saveString]);
				window.navigator.msSaveBlob(blob1, fileName);
			}
		}
	}
	
	// API_SaveDataURL will take a dataURL string (representing a binary object), 
	// and save it as a binary file
	function API_SaveDataURL(fileName, dataURL) {
		var fileBlob = API_DataUrlToBlob(dataURL);
		
		// if not using internet explorer then fallback to filesaver.js polyfill method
		if (window.navigator.msSaveBlob === undefined) {
			saveAs(fileBlob, fileName);
		}
		else {
			window.navigator.msSaveOrOpenBlob(fileBlob, fileName);
		}
	}
	
	// Pass in a filename and some text to save and this will 'serve' up that text as a download
	function API_SaveOrOpenTextFile(fileName, saveString) {
		// The File Loaders seem to place a lock on the file so, in the event they are saving to the same filename,
		// lets clear out the old file control so that (if they save to the same filename as they last loaded) it will work.
		var control = $("#sb_user_file");
		control.replaceWith( control = control.clone( true ) );
		
		if (typeof Blob == "undefined") {
			alert('no blobs available (incompatible browser?)');
		}
		else {
			var blob1 = new Blob([saveString]);
			window.navigator.msSaveOrOpenBlob(blob1, fileName);
		}
	}
	
	function ToggleMaximize() {
		var isCaptionVisible = $("#sb_div_caption").is(":visible");
		//var isLoaderVisible = $("#sb_div_mainloader").is(":visible");
		
		// If mode 3 (dev bar only), then transition to mode 1 (all visible)
		//if (isLoaderVisible == false) {
		//	$("#sb_div_caption").show();
		//	$("#sb_div_mainloader").show();
		//}
		//else {
			// if all are visible then switch to mode 2 (hide caption only)
			if (isCaptionVisible) {
				$("#sb_div_caption").hide();
			}
			// else was in mode 2 (loader+dev bar), switch to mode 3 (dev bar only)
			else {
				$("#sb_div_caption").show();
			}
		//}
		
		sb_fit_editors();
		sb_fit_log();
	}
	
	function API_SetToolbarMode(showCaption, showLoader) {
		if (showCaption) {
			$("#sb_div_caption").show();
		}
		else {
			$("#sb_div_caption").hide();
		}
		
		if (showLoader) {
			$("#sb_div_mainloader").show();
		}
		else {
			$("#sb_div_mainloader").hide();
		}
		
		sb_fit_log();
		sb_fit_editors();
	}
	
	// Determines whether the Code or the Output areas get full width or if they split 50/50
	function API_SetWindowMode(mode) {
		
		// Code Only
		if (mode == 1) {
			VAR_WindowMode = mode;
			showMarkup = true;
			showScript = true;
			$('#tdOutput').attr('width', '0%');
			$('#tdCode').attr('width', '100%');
			$('#divCode').show();
			$('#tblCode').css('table-layout', '');
		
			$("#UI_TabsOutput").hide();
			
			$('.CodeMirror').each(function(i, el){
				el.CodeMirror.refresh();
			});
		}
		
		// Show Code and Output areas
		if (mode == 2) {
			VAR_WindowMode = mode;
			showMarkup = true;
			showScript = true;
			$('#tdCode').attr('width', '50%');
			$('#tdOutput').attr('width', '50%');
			$('#divCode').show();
			$('#tblCode').css('table-layout', 'fixed');
		
			$("#UI_TabsOutput").show();
			
			$('.CodeMirror').each(function(i, el){
				el.CodeMirror.refresh();
			});

		}
		
		// Show Output only
		if (mode == 3) {
			VAR_WindowMode = mode;
			showMarkup = true;
			showScript = true;
			$('#tdCode').attr('width', '0%');
			$('#tdOutput').attr('width', '100%');
			$('#divCode').hide();
			$('#tblCode').css('table-layout', '');
			
			$("#UI_TabsOutput").show();
		}
	}
	
	function API_RestoreLayout() {
		API_UserFullscreenExit();
		API_SetToolbarMode(true, true);
		API_SetWindowMode(2);
	}
	
	function API_SetBackgroundColor(colorCode) {
		$("#UI_Tab_Main").css("background-color", colorCode);
		$("#UI_MainPlaceholder").css("background-color", colorCode);
	}
	
	function API_Inspect(objVar) {
		var tbl = prettyPrint( objVar, { /* options such as maxDepth, etc. */ });
		$(tbl).dialog({ title: 'Trident Object/Variable Inspector', width: 'auto', maxHeight: ($(window).height() - 50) });
	}

	function selectTheme() {
		var theme = $("#selTheme option:selected").val();
		if (localStorage) {
			localStorage["editor-theme"] = theme;
		}

		editorMarkup.setOption("theme", theme);
		editorScript.setOption("theme", theme);
	}
	
	function API_GetCursor(callback) {
		var transaction = VAR_TRIDENT_DB.transaction(["TridentSandboxKVP"], "readonly");
		var store = transaction.objectStore("TridentSandboxKVP");

		var cursor = store.openCursor();
	 
		cursor.onsuccess = callback;
	}
	
	function API_ShowPasswordDialog(callback) {
		if (typeof(callback) != "function") API_LogMessage("Call to API_ShowPasswordDialog() with invalid callback param.");
		
		$("#UI_PasswordDialog").show();
		$("#sb_password_text").focus();
		$("#sb_password_ok").unbind("click");
		$("#sb_password_ok").bind("click", function() { callback($("#sb_password_text").val()); });
	}
	
	// Wrapping all Storage Summary functionality into this object
	var sb_dashboard = {
		tdbplot: null,
		lsplot: null,
		gaugeLS: null,
		gaugeTDB: null,
		
		calcSummaryUsage: function() {
			$("#spn_TridentDatabaseUsage").text("");
			$("#ui_gaugeTDBspin").show();
			
			setTimeout(function() { sb_dashboard.calcSummaryUsageAction() }, 100);
		},
		
		apiUseTrident: function() {
			VAR_TRIDENT_API.SwitchMode("trident");
			$("#ui_api_lblMode").text(VAR_TRIDENT_API.mode);
		},
		
		apiUseService: function() {
			VAR_TRIDENT_API.SwitchMode("service");
			$("#ui_api_lblMode").text(VAR_TRIDENT_API.mode);
		},
		
		apiSaveService: function() {
			var svcLoc = $("#ui_api_txtService").val();
			
			if (svcLoc.indexOf("/", svcLoc.length - 1) == -1) svcLoc = svcLoc + "/";

			VAR_TRIDENT_API.SetServiceLocation(svcLoc);
			
			$("#ui_api_txtService").val(VAR_TRIDENT_API.baseUrl);
		},
		
		calcSummaryUsageAction: function() {
			var totalSizeTDB = 0;

			if (sb_dashboard.gaugeLS) { sb_dashboard.gaugeLS.destroy(); }
			if (sb_dashboard.gaugeTDB) { sb_dashboard.gaugeTDB.destroy(); }
			
			$("#ui_api_lblMode").text(VAR_TRIDENT_API.mode);
			$("#ui_api_txtService").val(VAR_TRIDENT_API.baseUrl);
			
			API_GetCursor(function(e) {
				var cursor = e.target.result;
				if(cursor) {
					var currObject = cursor.value;
					
					// add app, key, appkey and val lengths
					var keySize = currObject.app.length*2 + currObject.key.length*2 + currObject.val.length;
					totalSizeTDB += keySize;
					
					cursor.continue();
				}
				else {
					var totalSizeLS = 0;

					for (var i = 0; i < localStorage.length; i++) {
						var keySize = localStorage[localStorage.key(i)].length;
						totalSizeLS += keySize;
					}
					
					$("#spn_LocalStorageUsage").text(totalSizeLS + " bytes (" + Math.round((totalSizeLS/1024)/1024 *100)/100 + "MB)");
					
					var s1 = [(totalSizeLS/1024)/1024];

					sb_dashboard.gaugeLS = $.jqplot('ui_gaugeLS',[s1],{
						seriesDefaults: {
							renderer: $.jqplot.MeterGaugeRenderer,
							rendererOptions: {
								label: '(Actual) Usage in MB',
								labelPosition: 'bottom',
								min: 0,
								max: 5,
								intervals:[1.25, 2.5, 3.5, 5],
								intervalColors:['#66cc66', '#93b75f', '#E7E658', '#cc6666']
							}
						}
					});
					
					if ($("#UI_TabsDashboard").tabs("option", "active") != 0) return;
					
					$("#ui_gaugeTDBspin").hide();
					
					$("#spn_TridentDatabaseUsage").text(totalSizeTDB + " bytes (" + Math.round((totalSizeTDB/1024)/1024 *100)/100 + "MB)");
					
					var s2 = [(totalSizeTDB/1024)/1024];

					sb_dashboard.gaugeLS = $.jqplot('ui_gaugeTDB',[s2],{
						seriesDefaults: {
							renderer: $.jqplot.MeterGaugeRenderer,
							rendererOptions: {
								label: '(Actual) Usage in MB',
								labelPosition: 'bottom',
								min: 0,
								max: 120,
								intervals:[30, 60, 90, 120],
								intervalColors:['#66cc66', '#93b75f', '#E7E658', '#cc6666']
							}
						}
					});
				}
			});
			
		},
	
		calcTridentDbUsage: function() {
			$("#ui_tdb_spnTotalSize").text("");
			$("#ui_chartTDBspin").show();
			
			setTimeout(function() { sb_dashboard.calcTridentDbUsageAction() }, 100);
		},
		
		calcTridentDbUsageAction: function() {
   
			$("#ui_tdb_txtAppName").val("");
			$("#ui_tdb_txtKeyName").val("");
			$("#ui_tdb_txtKeySize").val("");
			
			// if already plotted, destroy old plot before replotting
			if (sb_dashboard.tdbplot) { sb_dashboard.tdbplot.destroy(); }
			
			// clear array of [key,sizes]
			var arrayTDB = [];
			var tdbu_counter = null;

			// repopulate the listbox while simultaneously building the arrayTDB data for plot
			$("#ui_tdb_selTridentDB").html("");
			
			var totalSize = 0;

			VAR_TRIDENT_API.GetAllKeys(function(result) {
				tdbu_counter = result.length;
			
				for (var idx = 0; idx < result.length; idx++) {
					VAR_TRIDENT_API.GetAppKeyById(result[idx].id, function (result) {
						var currObject = result;
				  
						$('#ui_tdb_selTridentDB').append($('<option>', {
							value: currObject.id,
							text: currObject.app + ";" + currObject.key
						}));          
				  
						var keySize = currObject.val.length + currObject.app.length + currObject.key.length;
						if (VAR_TRIDENT_API.mode == "trident") {
							keySize = currObject.app.length*2 + currObject.key.length*2 + currObject.val.length;
						}
						totalSize += keySize;
						
						arrayTDB.push([currObject.key.slice(0,20), keySize]);
						//cursor.continue();
					
						//sbv.arrayLS.push([currObject.key.slice(0,20), keySize]);
						
						if (--tdbu_counter == 0) {
							if ($("#UI_TabsDashboard").tabs("option", "active") != 2) return;
							
							if (totalSize == 0) $("#ui_div_trident_usage").hide();
							else $("#ui_div_trident_usage").show();
						
							$("#ui_tdb_spnTotalSize").text(totalSize + " bytes (" + Math.round((totalSize/1024)/1024 *100)/100 + "MB) " + 
								((VAR_TRIDENT_API.mode == 'trident')?"TridentMode":"ServiceMode"));				
							
							$("#ui_chartTDBspin").hide();
							
							if (arrayTDB.length == 0) return;
							
							sb_dashboard.tdbplot = jQuery.jqplot ('ui_tdb_chartTridentUsage', [arrayTDB], 
							{ 
								seriesDefaults: {
									// Make this a pie chart.
									renderer: jQuery.jqplot.PieRenderer, 
									rendererOptions: {
										// Put data labels on the pie slices.
										// By default, labels show the percentage of the slice.
										showDataLabels: true
										//dataLabels: ['label']
									}
								}, 
								legend: { show:false, location: 'e' },
								highlighter: {
								  show: true,
								  formatString:'%s', 
								  tooltipLocation:'sw', 
								  useAxesFormatters:false
								}
							});
						}
					});
				}
			});

		},
		
		deleteTridentKey : function() {
			var objId = $("#ui_tdb_selTridentDB option:selected").val();

			VAR_TRIDENT_API.DeleteAppKey(parseInt(objId), function(result) {
				sb_dashboard.calcTridentDbUsage();
			});
		},
		
		selTdbChanged: function () {
			var keyId = $("#ui_tdb_selTridentDB option:selected").val();

			VAR_TRIDENT_API.GetAppKeyById(parseInt(keyId), function(result) {
				if (result.app  == "TridentFiles") $("#ui_tdb_download").show();
				else $("#ui_tdb_download").hide();
				
				$("#ui_tdb_txtAppName").val(result.app);
				$("#ui_tdb_txtKeyName").val(result.key);
				$("#ui_tdb_txtKeySize").val(result.val.length + " bytes");
			});
		},
		
		downloadTridentFile: function() {
			var objId = $("#ui_tdb_selTridentDB option:selected").val();

			VAR_TRIDENT_API.GetAppKeyById(parseInt(objId), function(result) {
				var fileName = result.key.replace("TridentFiles;", "");
				var dataURL = result.val;
				API_SaveDataURL(fileName, dataURL);
			});
		},
		
		renameTridentKey: function() {
			var objId = $("#ui_tdb_selTridentDB option:selected").val();

			VAR_TRIDENT_API.GetAppKeyById(parseInt(objId), function(result) {
				VAR_TRIDENT_API.SetAppKey(result.app, $("#ui_tdb_txtKeyName").val(), result.val, function(setres) {
					if (setres.success) {
						VAR_TRIDENT_API.DeleteAppKey(parseInt(objId), function(delres) {
							sb_dashboard.calcTridentDbUsage();
						});
					}
				});
			});
		},

		calcLocalStorageUsage: function() {
			if (sb_dashboard.lsplot) { sb_dashboard.lsplot.destroy(); }
			
			var arrayLS = [];

			$("#ui_ls_txtKeyName").val("");
			$("#ui_ls_txtKeySize").val("");
			$("#ui_ls_txtLocalStorageValue").text("");

			// repopulate the listbox while simultaneously building the arrayLS data for plot
			$("#ui_ldb_selLocalStorage").html("");
			
			var totalSize = 0;

			for (var i = 0; i < localStorage.length; i++) {
				var keyName = localStorage.key(i);
				var keySize = localStorage[localStorage.key(i)].length;
				
				arrayLS.push([keyName, keySize]);
				
				totalSize += keySize;
				
				$('#ui_ldb_selLocalStorage').append($('<option>', {
					value: localStorage.key(i),
					text: localStorage.key(i)
				}));          
			}
			
			var my_options = $("#ui_ldb_selLocalStorage option");
			my_options.sort(function(a,b) {
				if (a.text > b.text) return 1;
				else if (a.text < b.text) return -1;
				else return 0
			})
			$("#ui_ldb_selLocalStorage").empty().append( my_options );
			
			if (totalSize == 0) $("#ui_div_local_usage").hide();
			else $("#ui_div_local_usage").show();
			
			$("#ui_ldb_spnTotalSize").text("Total Size of Local Storage : " + totalSize + " bytes (" + Math.round((totalSize/1024)/1024 *100)/100 + "MB)");

			if (arrayLS.length == 0) return;
			
			// now (re) plot the data we just accumulated
			sb_dashboard.lsplot = jQuery.jqplot ('ui_ldb_chartLocalUsage', [arrayLS], 
			{ 
				seriesDefaults: {
					// Make this a pie chart.
					renderer: jQuery.jqplot.PieRenderer, 
					rendererOptions: {
					  // Put data labels on the pie slices.
					  // By default, labels show the percentage of the slice.
					  showDataLabels: true
					  //dataLabels: ['label']

					}
				}, 
				highlighter: {
				  show: true,
				  formatString:'%s', 
				  tooltipLocation:'sw', 
				  useAxesFormatters:false
				},
				legend: { show:false, location: 'e' }
			});
		},
		
		saveLSKey : function() {
			var key = $("#ui_ls_txtKeyName").val();
			var val = $("#ui_ls_txtLocalStorageValue").text();
			
			localStorage[key] = val;
			sb_dashboard.calcLocalStorageUsage();
		},
		
		selectLSKey: function() {
			var key = $("#ui_ldb_selLocalStorage option:selected").text();

			$("#ui_ls_txtKeyName").val(key);
			$("#ui_ls_txtKeySize").val(localStorage[key].length + " bytes");
			$("#ui_ls_txtLocalStorageValue").text(localStorage[key]);
		},

		deleteLSKey: function() {
			var key = $("#ui_ldb_selLocalStorage option:selected").text();
			if (key == "") {
				alertify.error("You need to select key from the list before deleting");
				return;
			}

			// user clicked "ok"
			localStorage.removeItem(key);
			sb_dashboard.calcLocalStorageUsage();
		}
	}
	
	function sb_show_dashboard() {
		var dlgWidth = 1024;
		
		if ($(window).width() < 1044) dlgWidth = $(window).width() - 20;
		
		$("#sb_trident_usage").dialog({ 
			width: dlgWidth,
			title: 'Trident Sandbox Storage Summary',
			open: function() {
				if ($("#UI_TabsDashboard").tabs("option", "active") != 0) {
					$("#UI_TabsDashboard").tabs("option", "active", 0);
				}
				else {
				  sb_dashboard.calcSummaryUsage();
				}
			},
			buttons : {
				Ok : function() { 
					$(this).dialog( "destroy" );
					
					if (VAR_TRIDENT_API != null) {
						if (VAR_TRIDENT_API.mode == "trident") {
							$("#sb_spn_indexeddb_status").text("Yes");
						}
						else {
							$("#sb_spn_indexeddb_status").html("Yes <span style='font-family:Symbol'>Å</span>");
						}
					}
					
					sb_refresh_slots();
				}, 
				Cancel : function() {
					$(this).dialog( "destroy" );
				}
			}
		});
	}
	
// END API/HELPER ROUTINES


</script>
</head>
<body bgcolor="#1F7DD0" style="background-color:#1F7DD0">

<div id="sb_div_caption" style="border:0px solid #333; padding:0px 0px; background:#777;align:center;">
<table width="100%" cellpadding="0" cellspacing="0">
	<tr>
		<td valign='top'>
			<div style="float:left"><img src='images_ide/poseidon.png' /></div>
			<div style="float:left; padding:0px;" id="sb_div_diagnostic">
				<table style="border:1px solid; background-color:#ccc; color:#000">
					<tr>
						<td>
						<div class="divWideButtons" style="display:inline">Local Storage : </div>
						<div class="divTinyButtons" style="display:inline">LS : </div>
						<span id="sb_spn_localstorage_status">N/A</span></td>
					</tr>
					<tr><td>
						<div class="divWideButtons" style="display:inline">Indexed Db :</div>
						<div class="divTinyButtons" style="display:inline">IDB : </div>
						<span id="sb_spn_indexeddb_status">N/A</span></td></tr>
					<tr><td>
						<div class="divWideButtons" style="display:inline">AppCache :</div>
						<div class="divTinyButtons" style="display:inline">AC : </div>
						<span id="sb_spn_appcache_status">N/A</span>&nbsp;<span id="sb_spn_appcache_progress"></span></td></tr>
				</table>
			</div>
		</td>
		<td>
			<div class="divWideButtons" style="display:inline">
			<h2 class="tlt" id='sb_header_caption' title='Trident Sandbox (WinJS version)' onclick="sb_toggle_header_font()" align='center' style="width:90%; font-family: 'Heorot'; text-shadow: 0px 0px 7px rgba(0,0,0,0.75); color:#FFFF99;">Trident Sandbox with WinJS framework</h2>
			</div>
			<div class="divTinyButtons" style="display:inline">
			<h3 id='sb_header_caption2' title='Trident Sandbox (WinJS version)' align='center' style="width:90%; font-family: 'Heorot'; text-shadow: 0px 0px 7px rgba(0,0,0,0.75); color:#FFFF99;">Trident Sandbox with WinJS framework</h3>
			</div>
		</td>
		<td>
			<div>
				<a class="TridentLink" style="text-shadow: 0px 0px 7px rgba(0,0,0,0.75); font-family:'heorot'" href="docs/Welcome.htm" target="_blank">HELP</a>&nbsp;
				<a class="TridentLink" style="text-shadow: 0px 0px 7px rgba(0,0,0,0.75); font-size:16px; font-family:'heorot'" href="http://dev.windows.com/en-us/develop/winjs" target="_blank">WinJS Info</a><br/>
				<a class="TridentLink" title="Click here to run the normal version" style="text-shadow: 0px 0px 7px rgba(0,0,0,0.75); font-size:16px; font-family:'heorot'" href="TridentSandbox.htm">Regular version</a></div>
		</td>
	</tr>
</table>
</div>

<div id="sb_div_mainloader" style="background-color:#aba; border:0px; padding:2px">
<table width="100%" style="font-family:Tahoma">
<tr>

<td>
Prog Name : 
<input style='height:24px; width:160px; ' id='sb_txt_ProgramName' type='text' placeholder="Enter program name here" value=''/>
<input style='height:30px;width:110px;' id='sb_file' type="file" name="fileloader" onchange="sb_load()" />
</td>
<td style="align:'right'">
<select onchange="selectTheme()" id='selTheme' style='font-size:16px;'>
    <option selected>default</option>
    <option>3024-day</option>
    <option>3024-night</option>
    <option>ambiance</option>
    <option>base16-dark</option>
    <option>base16-light</option>
    <option>blackboard</option>
    <option>cobalt</option>
    <option>eclipse</option>
    <option>elegant</option>
    <option>erlang-dark</option>
    <option>lesser-dark</option>
    <option>mbo</option>
    <option>mdn-like</option>
    <option>midnight</option>
    <option>monokai</option>
    <option>neat</option>
    <option>neo</option>
    <option>night</option>
    <option>paraiso-dark</option>
    <option>paraiso-light</option>
    <option>pastel-on-dark</option>
    <option>rubyblue</option>
    <option>solarized dark</option>
    <option>solarized light</option>
    <option>the-matrix</option>
    <option>tomorrow-night-eighties</option>
    <option>twilight</option>
    <option selected='selected'>vibrant-ink</option>
    <option>xq-dark</option>
    <option>xq-light</option>
</select>


</td>
<td style="vertical-align:middle">
<div style="display:none" id="sb_div_compile_standalone">
Pick a template to use : <input style='height:30px;width:90px;' id='sb_file_template' type="file" name="sb_file_template" onchange="sb_compile_template()" />
<button style='height:30px;' onclick="$('#sb_div_compile_standalone').hide()">Cancel</button>
</div>
</td>
<td align='center'>
<div class="divWideButtons" style="display:inline">
</div>
<div class="divTinyButtons" style="display:inline">
</div>
</td>
<td>
<div class="divWideButtons" style="display:inline">
<button class="TridentButton" style='height:40px; float:right' title='Toggle Maximize' onclick="ToggleMaximize()"><img src="images_ide/nixus/32x32/Options.png"/></button>
<button class="TridentButton" style='height:40px; float:right' title="Clear Sandbox" onclick="sb_new_program()"><img src='images_ide/add.png'/> New</button>
<button style='height:40px; float:right' id="ui_browse_samples" class="ui_browse_samples" onclick="sb_browse_samples()" ><img src='images_ide/nixus/32x32/Tutorial-16.png'/> Samples Browser</button>
<button style='height:40px; float:right; display:none;' id="ui_show_dashboard" class="ui_show_dashboard" onclick='sb_show_dashboard()' title='Show Dashboard'><img src='images_ide/chart_pie.png'/> Storage Summary</button>
<button style='height:40px; float:right' id="ui_gen_sa" class="ui_gen_sa" onclick='sb_loadtemplate()' title='Generate Standalone HTML app'><img src='images_ide/cog.png'/> Generate S/A</button>
</div>
<div class="divTinyButtons" style="display:inline">
<button class="TridentButton" style='height:40px; float:right' title='Toggle Maximize' onclick="ToggleMaximize()"><img src="images_ide/nixus/32x32/Options.png"/></button>
<button class="TridentButton" style='height:40px; float:right' title="Clear Sandbox" onclick="sb_clean_sandbox()"><img src='images_ide/add.png'/></button>
<button style='height:40px; float:right' id="ui_browse_samples2" class="ui_browse_samples" onclick="sb_browse_samples()" ><img src='images_ide/nixus/32x32/Tutorial-16.png'/></button>
<button style='height:40px; float:right; display:none;' id="ui_show_dashboard2" class="ui_show_dashboard" onclick='sb_show_dashboard()' title='Show Dashboard'><img src='images_ide/chart_pie.png'/></button>
<button style='height:40px; float:right' id="ui_gen_sa2" class="ui_gen_sa" onclick='sb_loadtemplate()' title='Generate Standalone HTML app'><img src='images_ide/cog.png'/></button>
</div>
</td>
</tr>
</table>
</div>

<table id="tblCode" style="width: 100%; table-layout:fixed">
	<tr style="background-color:#bbb;"><td colspan="2">
		<div id="ui_editor_toolbar" style="font-size:4px; display:inline-block">
			<button class="TridentButton" id="sb_btn_markup" style="height:32px" onclick="sb_toggle_markup()" title='Show Markup only (Alt+Q)'><i class="fa fa-code"></i> Mkp</button> 
			<button class="TridentButton" id="sb_btn_togglesplit" style="height:32px" onclick="sb_toggle_split()" title='Toggle split Side-by-Side / Top-Bottom'><i class="fa fa-columns"></i> Split</button> 
			<button class="TridentButton" id="sb_btn_script" style="height:32px" onclick="sb_toggle_script()" title='Show Script only (Alt+W)'><i class="fa fa-gears"></i> Script</button>
			<button class="TridentButton" id="sb_btn_inpect" style="height:32px" onclick="sb_inspect()" title='Inspect an object or variable (Alt+I)'><i class="fa fa-eye"></i> Inspect</button>
			<div id='sb_div_ls_slots' style='display:none'>
				<button class="TridentButton" style="height:32px" title='Load from selected TridentDB save slot' onclick='sb_load_slot()'>LoadDB</button>
				<button class="TridentButton" style="height:32px" title='Save to selected TridentDB save slot' onclick='sb_save_slot()'>SaveDB</button>
				<select style="height:24px; font-size: 14px;" id='sb_sel_trident_slot' onchange="sb_load_slot()"></select>
				<button class="TridentButton" style="height:32px" title='Delete the selected TridentDB save' onclick='sb_del_slot()'>DelDB</button>
			</div>
			<div style="display:inline-block">
			<button class="ui_btn_launch" style='height:32px; display:none' onclick="sb_launch()" title="Save and Launch in new Window"><i class="fa fa-external-link"></i> Launch</button>
			<button class="TridentButton" style='height:32px;' onclick="sb_save()" title="Save your program (Alt+S)"><i class="fa fa-save"></i> Save</button>
			<button class="TridentButton" id="sb_btn_fscode" style="height:32px" onclick="sb_fs_code()" title='Zoom the dev area fullscreen'><i class="fa fa-arrows-alt"></i> FS Dev</button>
			<button class="TridentButton" style='height:32px;' title='Clear Output Tabs' onclick="API_ClearOutput()"><i class="fa fa-eraser"></i> CLR</button>
			<button class="TridentButton" id="ui_btn_run" style='height:32px; width:80px;' onclick="sb_run()" title="Run your Program (Alt+R)"><b><i class="fa fa-play" style="color:#4b4"></i> RUN</b></button>
			</div>
			<div style="display:inline">
				<button class="TridentButton" style='height:32px; width:40px' title='Code Only (Alt-1)' onclick='API_SetWindowMode(1)'>1</button>
				<button class="TridentButton" style='height:32px; width:40px' title='Split 50/50 (Alt-2)' onclick='API_SetWindowMode(2)'>2</button>
				<button class="TridentButton" style='height:32px; width:40px' title='Output Only (Alt-3)' onclick='API_SetWindowMode(3)'>3</button>
			</div>
		</div>
	</td></tr>
	<tr>
	<td id="tdCode" width="50%" valign='top' style="padding: 0px">
		<div id='divCode' style="display:none; background-color:#ccc; background: rgba(128, 128, 128, 0.0);">
			<table style="width:100%; table-layout:fixed" cellpadding=0 cellspacing=0>
			<tr><td>
				<div id="ui_div_markup" style="float:left; width:50%; padding-top:1px">
				<textarea spellcheck='false' style='font-family="Lucida Console"' id='sb_txt_Markup' rows='24'></textarea>
				</div>
				<div id="ui_div_script" style="float:left; width:50%; padding-top:1px">
				<textarea spellcheck='false' style='font-family="Lucida Console"' id='sb_txt_Script' rows='24'></textarea>
				</div>
			</td></tr>
			</table>
		</div>
	</td>
	<td id="tdOutput" valign='top' style="padding: 0px">
		<div id="UI_TabsOutput">
			<ul>
				<li><a href="#UI_Tab_Main">Main Output</a></li>
				<li><a href="#UI_Tab_Html">Log (HTML)</a></li>
				<li><a href="#UI_Tab_Text">Log (Text)</a></li>
			</ul>
			<div id="UI_Tab_Main" style="overflow: auto;">
				<div id='sb_div_userfile' style="display:none">
					<input style='height:30px;width:400px;' id='sb_user_file' type="file" name="userfileloader" onchange="sb_user_load()" />
					<button id="sb_btn_user_file_cancel" onclick="$('#sb_div_userfile').hide()">Cancel</button>&nbsp;&nbsp;[Text]
				</div>
				<div id='sb_div_userdatafile' style="display:none; background-color:#cdc">
					<input style='height:30px;width:400px;' id='sb_user_datafile' type="file" name="userdatafileloader" onchange="sb_user_dataload()" />
					<button id="sb_btn_user_datafile_cancel" onclick="$('#sb_div_userdatafile').hide()">Cancel</button>&nbsp;&nbsp;[Binary]
				</div>
				<div id='UI_LibUnitPlaceholder' style="display:none"></div>
				<div class="UI_MainPlaceholder" id='UI_MainPlaceholder' style='background-color:#444;min-height:300px'><br/><br/></div>
			</div>
			<div id="UI_Tab_Html" style="overflow: auto;">
				<div id='UI_HtmlLogPlaceholder' style='background-color:white'><br/><br/></div>
			</div>
			<div id="UI_Tab_Text" style="background-color:#555">
				<div id='sb_div_restorefile' style="display:none;color:#ccc">
					<input style='height:30px;width:400px;' id='sb_restore_file' type="file" name="restorefileloader" onchange="sb_restore_load()" />
					<button id="sb_btn_restore_file_cancel" onclick="$('#sb_div_restorefile').hide()">Cancel</button>&nbsp;&nbsp;[Pick Restore File]
				</div>
				<div id='sb_div_LogPlaceholder' style='background-color:#555;'>
					<textarea id="UI_TxtLogText" spellcheck='false' rows='30' style="font-family: Lucida Console; height:100; width:100%; background-color:#333; color:#ccc">You need to allow blocked content for Trident Sandbox to initialize.</textarea><br/>
					<input type='text' id='UI_TxtLogConsole' style="width:100%;height:30px; background-color:#333; color:#ccc" onKeyDown="{ if (event.keyCode==38) $('#UI_TxtLogConsole').val(sb_lastconsolecmd) }" onKeyPress="{ if (event.keyCode==13) sb_console_eval() }"/>
				</div>
			</div>
		</div>
	</td>
	</tr>
</table>
</div>

	<div id="UI_PasswordDialog" style="display:none">

		<h3><span class="fa"><i class="fa fa-lock"></i></span> Authorization</h3>

		<form action="javascript:void(0);" method="POST">

			<fieldset>

				<p><label for="password">Enter Password</label>
				<input id="sb_password_text" type="password" id="password" value="" placeholder="password" >
                </p>
				<p>
                	<button id="sb_password_ok" onclick="$('#UI_PasswordDialog').hide();">Ok</button>
					<button onclick="$('#UI_PasswordDialog').hide();">Cancel</button>
        		</p>

			</fieldset>

		</form>

	</div> <!-- end login -->


<div id='sb_trident_usage' style="display:none">
	<div id="UI_TabsDashboard">
		<ul>
			<li><a href="#UI_Tab_Summary">Storage Summary</a></li>
			<li><a href="#UI_Tab_LocalStorageUsage">LocalStorage Usage</a></li>
			<li><a href="#UI_Tab_TridentDbUsage">TridentDB Usage</a></li>
			<li><a href="#UI_Tab_TridentAPI">Trident API</a></li>
		</ul>
		<div id="UI_Tab_Summary" style="overflow: auto;">
			<table>
				<tr>
					<th>Local Storage</th>
					<th>Trident DB (IndexedDb)</th>		
				</tr>
				<tr>
					<td align='center'>
						<span id='spn_LocalStorageUsage'></span>
						<br/>
						<div id="ui_gaugeLS" style="height:200px; width:300px;"></div>
					</td>
					<td align='center'>
						<span id='spn_TridentDatabaseUsage'></span>
						<br/>
						<div id="ui_gaugeTDBspin"><i class="fa fa-spinner fa-spin"></i><br/><br/>Please wait...</div>
						<div id="ui_gaugeTDB" style="height:200px; width:300px;"></div>
					</td>
				</tr>
			</table>
			<ul>
			<li>Limits of 5 MB for Local Storage and 120 MB for IndexedDB are based on tests using IE 11 on Windows 8.1 and RT 8.1</li>
			<li>The TridentDb (IndexedDb) gauge assumes there are no other IndexedDb databases besides the TridentDB. </li>
			<li>Sizes reported by Internet Options/General/Settings/Caches and Databases are double due to Unicode encoding</li>
			</ul>
		</div>
		<div id="UI_Tab_LocalStorageUsage" style="overflow: auto;">
			<span id='ui_ldb_spnTotalSize'></span><br/>
			<div id='ui_div_local_usage'>
			<table>
				<tr>
					<td valign='top'>
						<div id="ui_ldb_chartLocalUsage" style="height:300px; width:300px;"></div>
					</td>
					<td valign='top' style='padding-top:10px'>
						<select id="ui_ldb_selLocalStorage" size=10 onchange="sb_dashboard.selectLSKey()"></select><br/>
						<button class="minimal" style="height:40px; width:100px" onclick="sb_dashboard.deleteLSKey()">Delete</button>
					</td>
					<td valign='top' style='padding-top:10px'>
						<div style="background-color:#f0f0f0; padding: 15px">
						<table>
						<tr>
							<td>Key<br/>
								<input type='text' id='ui_ls_txtKeyName' style='width:220px'/>
							</td>
						</tr>
						<tr>
							<td>Size<br/>
								<input type='text' id='ui_ls_txtKeySize' style='width:220px'/>
							</td>
						</tr>
						<tr>
							<td>Value<br/>
								<textarea spellcheck='false' rows='3' cols='60' id='ui_ls_txtLocalStorageValue'></textarea>
							</td>
						</tr>
						<tr>
							<td><button class="minimal" onclick="sb_dashboard.saveLSKey()">Save</button></td>
						</tr>
						</table>
						</div>
					</td>
				</tr>
			</table>
			</div>
		</div>
		<div id="UI_Tab_TridentDbUsage" style="overflow: auto;">
			Total Size : <span id='ui_tdb_spnTotalSize'></span><div style="display:inline" id="ui_chartTDBspin" ><i class="fa fa-spinner fa-spin"></i>&nbsp;Please wait...</div><br/>
			<div id='ui_div_trident_usage'>
			<table width='620px'>
			<tr>
				<td valign='top' align='center'>
					<div id="ui_tdb_chartTridentUsage" style="height:300px; width:300px;"></div>
				</td>
				<td valign='top' style='padding-top:10px'>
					<select id="ui_tdb_selTridentDB" size=11 onchange="sb_dashboard.selTdbChanged()"></select><br/>
					<button class="minimal" onclick="sb_dashboard.deleteTridentKey()">Delete</button>
					<button class="minimal" id="ui_tdb_download" style="display:none;" onclick="sb_dashboard.downloadTridentFile()">Download</button>
				</td>
				<td valign='top' style='padding-top:10px'>
					<div style='background-color:#f0f0f0; padding: 15px'>
					<table>
					<tr>
						<td>App<br/>
							<input type='text' id='ui_tdb_txtAppName' style='width:220px'/>
						</td>
					</tr>
					<tr>
						<td>Key<br/>
							<input type='text' id='ui_tdb_txtKeyName' style='width:220px'/>
						</td>
					</tr>
					<tr>
						<td>Size<br/>
							<input type='text' id='ui_tdb_txtKeySize' style='width:220px'/>
						</td>
					</tr>
					<tr>
						<td>
							<button class="minimal" onclick="sb_dashboard.renameTridentKey()">Rename</button>
						</td>
					</tr>
					</table>
					</div>
				</td>
			</tr>
			</table>
			</div>
		</div>
		<div id="UI_Tab_TridentAPI">
			<h3>Trident API Settings</h3>
			<i>Note: I recommend you do not touch this, Use Trident DB for now.  It does work however if you want to review the service implementation in scripts/tridentdb.js</i><br/><br/>
			<table>
				<tr>
					<td>Trident Mode :</td>
					<td><label id="ui_api_lblMode"></label>
				</tr>
				<tr>
					<td>Service Location :</td>
					<td><input type="text" id="ui_api_txtService" style='height:30px; width:420px'/>&nbsp;<button style="height:40px; width:80px" onclick="sb_dashboard.apiSaveService()">Update</button>
				</tr>
			</table><br/>
			<button class="minimal" style="width:200px;height:40px" onclick="sb_dashboard.apiUseTrident()">Use Trident DB</button>
			<button class="minimal" style="width:220px"  onclick="sb_dashboard.apiUseService()">Use Trident Service</button>
		</div>
	</div>

</div>
</body>
</html>


